<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calverse - AI Nutrition & Health</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCu5RfnRhT9refiyybPcW_IBt_7l5cgt2I",
            authDomain: "calverse-e3cdb.firebaseapp.com",
            projectId: "calverse-e3cdb",
            storageBucket: "calverse-e3cdb.appspot.com",
            messagingSenderId: "284415302963",
            appId: "1:284415302963:web:936ad62e589bad6fc9b246"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => console.error("Firebase persistence error: ", err));
        
        // Set local persistence for authentication
        setPersistence(auth, browserLocalPersistence);

        // Make auth and db globally available for other functions
        window.auth = auth;
        window.db = db;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            const preloader = document.getElementById('preloader');
            const appContainer = document.getElementById('app-container');
            const loginPage = document.getElementById('login-page');

            // Hide preloader after a delay
            setTimeout(() => {
                preloader.style.opacity = '0';
                preloader.addEventListener('transitionend', () => preloader.style.display = 'none');
                
                if (user) {
                    // User is signed in
                    loginPage.style.display = 'none';
                    appContainer.style.visibility = 'visible';
                    appContainer.style.opacity = '1';
                    setupApp(user);
                } else {
                    // User is signed out
                    appContainer.style.visibility = 'hidden';
                    appContainer.style.opacity = '0';
                    loginPage.style.display = 'flex';
                }
            }, 2000); // Preloader visibility duration
        });

    </script>

    <style>
        :root {
            --background-dark: #0A0A0A;
            --card-bg-dark: rgba(26, 26, 26, 0.75);
            --border-color-dark: rgba(42, 42, 42, 0.8);
            --text-primary-dark: #FFFFFF;
            --text-secondary-dark: #888888;

            --background-light: #F5F5F5;
            --card-bg-light: rgba(255, 255, 255, 0.75);
            --border-color-light: rgba(229, 229, 229, 0.8);
            --text-primary-light: #18181B;
            --text-secondary-light: #71717A;
            
            --primary: #FBBF24; /* Amber-400 */
            --primary-hover: #F59E0B; /* Amber-500 */
            --text-on-primary: #000000;
        }
        
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        body.overflow-hidden {
            overflow: hidden;
        }

        #parallax-bg {
            background-image: url('https://images.unsplash.com/photo-1490818387583-1b48b90b284a?q=80&w=2070&auto=format&fit=crop');
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0.1;
            transition: opacity 0.3s;
            filter: grayscale(100%);
        }
        @media (orientation: portrait) {
            #parallax-bg {
                background-image: url('https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?q=80&w=1887&auto=format&fit=crop');
            }
        }
        .light #parallax-bg {
            opacity: 0.2;
        }

        .glass-card {
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid;
        }

        .dark body { background-color: var(--background-dark); color: var(--text-primary-dark); }
        .dark .bg-card { background-color: var(--card-bg-dark); }
        .dark .border-card { border-color: var(--border-color-dark); }
        .dark .text-main { color: var(--text-primary-dark); }
        .dark .text-sub { color: var(--text-secondary-dark); }
        .dark .bottom-nav-inner { background: var(--card-bg-dark); border: 1px solid var(--border-color-dark); }
        .dark .nav-item-desktop.active { background-color: rgba(251, 191, 36, 0.1); color: var(--primary); }
        .dark .nav-item-mobile.active { color: var(--primary); }
        .dark .accordion-item { background-color: var(--card-bg-dark); border-color: var(--border-color-dark); }
        .dark .input-field { background-color: var(--background-dark); border-color: var(--border-color-dark); }
        .dark #settings-overlay { background-color: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); }

        .light body { background-color: var(--background-light); color: var(--text-primary-light); }
        .light .bg-card { background-color: var(--card-bg-light); }
        .light .border-card { border-color: var(--border-color-light); }
        .light .text-main { color: var(--text-primary-light); }
        .light .text-sub { color: var(--text-secondary-light); }
        .light .bottom-nav-inner { background: var(--card-bg-light); border: 1px solid var(--border-color-light); }
        .light .nav-item-desktop.active { background-color: rgba(251, 191, 36, 0.1); color: var(--primary); }
        .light .nav-item-mobile.active { color: var(--primary); }
        .light .accordion-item { background-color: var(--card-bg-light); border-color: var(--border-color-light); }
        .light .input-field { background-color: var(--background-light); border-color: var(--border-color-light); }
        .light #settings-overlay { background-color: rgba(245, 245, 245, 0.8); backdrop-filter: blur(10px); }

        .page { display: none; }
        .page.active { display: block; }
        
        .btn-primary {
            background: linear-gradient(to right, #FBBF24, #F59E0B);
            color: var(--text-on-primary);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(251, 191, 36, 0.6);
            border: none;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px -5px rgba(251, 191, 36, 0.8); }
        .btn-primary:disabled { background: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }

        .nutrition-label { border: 1px solid; border-radius: 0.75rem; padding: 1.5rem; max-width: 400px; margin: auto; }
        .dark .nutrition-label { background-color: var(--card-bg-dark); border-color: var(--border-color-dark); }
        .light .nutrition-label { background-color: var(--card-bg-light); border-color: var(--border-color-light); }
        .nutrition-label h1 { font-size: 2rem; font-weight: 800; line-height: 1.2; }
        .nutrition-label .header { border-bottom: 8px solid; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .dark .nutrition-label .header { border-color: var(--border-color-dark); }
        .light .nutrition-label .header { border-color: var(--border-color-light); }
        .nutrition-label .item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid; }
        .dark .nutrition-label .item { border-color: var(--border-color-dark); }
        .light .nutrition-label .item { border-color: var(--border-color-light); }
        .nutrition-label .item:last-child { border-bottom: none; }
        .nutrition-label .item span:first-child { font-weight: 600; }
        .nutrition-label .item .indent { margin-left: 1.5rem; }
        .nutrition-label .footer { border-top: 4px solid; padding-top: 0.75rem; margin-top: 0.75rem; }
        .dark .nutrition-label .footer { border-color: var(--border-color-dark); }
        .light .nutrition-label .footer { border-color: var(--border-color-light); }
        
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        
        .ai-content h3 { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-top: 1.5rem; margin-bottom: 1rem; }
        .ai-content ul { list-style-type: none; padding-left: 0; }
        .ai-content li { margin-bottom: 0.5rem; display: flex; align-items: flex-start; }
        .ai-content li::before { content: '✓'; color: var(--primary); font-weight: bold; margin-right: 0.75rem; margin-top: 0.125rem; }
        
        #settings-overlay { transition: transform 0.3s ease-in-out; }
        
        #custom-modal { display: none; }
        #custom-modal.show { display: flex; }

        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .skeleton-text { height: 1em; }
        .skeleton-title { height: 2.5rem; width: 60%; }
        .skeleton-line { height: 1.25rem; }

        ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: var(--background-dark); }
        .light ::-webkit-scrollbar-track { background: var(--background-light); }
        ::-webkit-scrollbar-thumb { background: #4A5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        #preloader {
            position: fixed;
            inset: 0;
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease-out;
        }
        .loader-container { display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .spinner-container { width: 100px; height: 100px; position: relative; display: flex; justify-content: center; align-items: center; }
        .spinner-center { width: 80px; height: 80px; background-color: #1c1c1c; border-radius: 50%; display: flex; justify-content: center; align-items: center; position: relative; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .orbiter { width: 18px; height: 18px; background-color: #FFC107; border-radius: 50%; position: absolute; top: 50%; left: 50%; margin: -9px; animation: orbit 3s linear infinite; }
        .icon { position: absolute; fill: #666; width: 50%; height: 50%; opacity: 0; transform: scale(0.9); transition: all 0.5s ease-in-out; animation: icon-fade 9s ease-in-out infinite; }
        .icon-recipes { animation-delay: -6s; }
        .icon-calculator { animation-delay: -3s; }
        .loader-text { display: flex; font-size: 2.5rem; font-weight: 600; font-family: 'Poppins', sans-serif; }
        .loader-text span { opacity: 0; transform: translateY(10px); background: linear-gradient(45deg, #FFC107, #FFA000); -webkit-background-clip: text; background-clip: text; color: transparent; animation: fade-up 1.8s ease-in-out infinite alternate; }
        .loader-text span:nth-child(1) { animation-delay: 0.1s; }
        .loader-text span:nth-child(2) { animation-delay: 0.2s; }
        .loader-text span:nth-child(3) { animation-delay: 0.3s; }
        .loader-text span:nth-child(4) { animation-delay: 0.4s; }
        .loader-text span:nth-child(5) { animation-delay: 0.5s; }
        .loader-text span:nth-child(6) { animation-delay: 0.6s; }
        .loader-text span:nth-child(7) { animation-delay: 0.7s; }
        .loader-text span:nth-child(8) { animation-delay: 0.8s; }
        @keyframes orbit { from { transform: rotate(0deg) translateX(50px) rotate(0deg); } to { transform: rotate(360deg) translateX(50px) rotate(-360deg); } }
        @keyframes icon-fade { 0%, 100% { opacity: 0; transform: scale(0.9); } 5% { opacity: 1; transform: scale(1); fill: #FFC107; } 11% { opacity: 1; transform: scale(1); fill: #FFC107; } 28% { opacity: 1; transform: scale(1); fill: #FFC107; } 33.33% { opacity: 0; transform: scale(0.9); fill: #666; } }
        @keyframes fade-up { from { opacity: 0.3; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #app-container { transition: opacity 0.5s ease-in; }

        .logo-container:hover i { animation: spin-once 0.6s ease-in-out; }
        @keyframes spin-once { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .nav-item-mobile:hover i { animation: bounce-sm 0.4s ease-in-out; }
        @keyframes bounce-sm { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-container">
            <div class="spinner-container">
                <div class="orbiter"></div>
                <div class="spinner-center">
                    <svg class="icon icon-meal" viewBox="0 0 57 57"><path d="M11.4,45.6 H45.6 C47.7,45.6 49.4,43.9 49.4,41.8 V39.9 C49.4,37.8 47.7,36.1 45.6,36.1 H11.4 C9.3,36.1 7.6,37.8 7.6,39.9 V41.8 C7.6,43.9 9.3,45.6 11.4,45.6 Z"/><rect x="7.6" y="29.5" width="41.8" height="6.6" rx="3.3"/><path d="M28.5,7.6 C18.2,7.6 9.5,15.2 7.9,24.7 H49.1 C47.5,15.2 38.8,7.6 28.5,7.6 Z"/><circle cx="20" cy="16" r="1.5"/><circle cx="28.5" cy="14" r="1.5"/><circle cx="37" cy="16" r="1.5"/></svg>
                    <svg class="icon icon-recipes" viewBox="0 0 57 57"><path d="M45.67,0H11.33C7.29,0,4,3.29,4,7.33V50c0,4.04,3.29,7.33,7.33,7.33h34.33c4.04,0,7.33-3.29,7.33-7.33V7.33C53,3.29,49.71,0,45.67,0z M14,8h12v4H14V8z M42,46H14v-4h28V46z M42,36H14v-4h28V36z M42,26H14v-4h28V26z"/></svg>
                    <svg class="icon icon-calculator" viewBox="0 0 57 57"><path d="M43.33,0H13.67C9.2,0,5.67,3.54,5.67,8v40c0,4.46,3.54,8,8,8h29.67c4.46,0,8-3.54,8-8V8C51.33,3.54,47.8,0,43.33,0z M22.5,48h-8v-6h8V48z M22.5,38h-8v-6h8V38z M22.5,28h-8v-6h8V28z M32.5,48h-6v-6h6V48z M32.5,38h-6v-6h6V38z M32.5,28h-6v-6h6V28z M42.5,48h-6v-6h6V48z M42.5,38h-6V22h6V38z M42.5,18h-28v-6h28V18z"/></svg>
                </div>
            </div>
            <div class="loader-text">
                <span>C</span><span>a</span><span>l</span><span>v</span><span>e</span><span>r</span><span>s</span><span>e</span>
            </div>
        </div>
    </div>

    <div id="parallax-bg" class="fixed inset-0 -z-10"></div>
    
    <div id="login-page" class="min-h-screen w-full flex items-center justify-center p-4" style="display: none;">
        <div class="w-full max-w-md space-y-6 bg-card border-card p-8 rounded-2xl glass-card">
            <div class="text-center">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div class="bg-primary text-text-on-primary rounded-lg h-12 w-12 flex items-center justify-center"><i data-lucide="bar-chart-3" class="w-8 h-8"></i></div>
                    <h1 class="text-4xl font-bold text-main">Calverse</h1>
                </div>
                <p class="text-sub">Sign in to continue your health journey.</p>
            </div>
            
            <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 p-3 border border-card rounded-lg hover:bg-primary/10 transition">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039L38.804 12.12C34.553 8.163 29.621 6 24 6C13.434 6 5 14.434 5 25s8.434 19 19 19s19-8.434 19-19c0-1.326-.134-2.616-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039L38.804 12.12C34.553 8.163 29.621 6 24 6C16.318 6 9.656 10.083 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.816 44 30.817 44 25c0-1.326-.134-2.616-.389-3.917z"></path></svg>
                <span class="font-semibold text-main">Sign in with Google</span>
            </button>

            <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-card"></div></div><div class="relative flex justify-center"><span class="bg-card px-2 text-sm text-sub">OR</span></div></div>
            
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" class="input-field w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition">
                <input id="password-input" type="password" placeholder="Password" class="input-field w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition">
                <div class="flex gap-4">
                    <button id="signin-btn" class="btn-primary w-full">Sign In</button>
                    <button id="signup-btn" class="w-full p-3 border border-card rounded-lg hover:bg-primary/10 transition font-semibold text-main">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex min-h-screen" style="visibility: hidden; opacity: 0;">
        <aside class="bg-card w-64 p-6 flex-col hidden md:flex border-r border-card glass-card">
            <div class="flex-grow">
                <div class="flex items-center gap-3 mb-10 logo-container">
                    <div class="bg-primary text-text-on-primary rounded-lg h-10 w-10 flex items-center justify-center"><i data-lucide="bar-chart-3"></i></div>
                    <h1 class="text-2xl font-bold text-main">Calverse</h1>
                </div>
                <nav class="flex flex-col gap-2">
                    <a href="#food" class="nav-item-desktop text-sub flex items-center gap-4 p-3 rounded-lg"><i data-lucide="layout-dashboard"></i><span class="font-semibold">Dashboard</span></a>
                    <a href="#meal" class="nav-item-desktop text-sub flex items-center gap-4 p-3 rounded-lg"><i data-lucide="utensils-crossed"></i><span class="font-semibold">Meal</span></a>
                    <a href="#recipes" class="nav-item-desktop text-sub flex items-center gap-4 p-3 rounded-lg"><i data-lucide="notebook-pen"></i><span class="font-semibold">Recipes</span></a>
                    <a href="#calculator" class="nav-item-desktop text-sub flex items-center gap-4 p-3 rounded-lg"><i data-lucide="calculator"></i><span class="font-semibold">Calculators</span></a>
                </nav>
            </div>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="p-4 md:p-8 flex items-center justify-between">
                <div class="flex items-center gap-3 md:hidden logo-container">
                     <div class="bg-primary text-text-on-primary rounded-lg h-10 w-10 flex items-center justify-center"><i data-lucide="bar-chart-3"></i></div>
                    <h1 class="text-xl font-bold text-main">Calverse</h1>
                </div>
                <h1 id="header-title" class="text-3xl font-bold hidden md:block text-main">Dashboard</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-card p-2 rounded-lg glass-card"><i data-lucide="calendar" class="w-5 h-5 text-primary"></i><span id="current-date" class="text-sm font-semibold text-main"></span></div>
                    <button id="profile-avatar-btn" class="focus:outline-none"><img id="user-avatar" src="https://placehold.co/40x40/FBBF24/000000?text=A" alt="User Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-primary"></button>
                </div>
            </header>

            <main class="flex-grow p-4 md:p-8 pb-28 md:pb-8">
                <div id="food" class="page space-y-8"></div>
                <div id="meal" class="page space-y-8"></div>
                <div id="recipes" class="page space-y-8"></div>
                <div id="calculator" class="page space-y-8"></div>
            </main>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 md:hidden z-10 p-4">
        <div class="bottom-nav-inner max-w-md mx-auto rounded-full shadow-lg glass-card">
            <nav class="flex justify-around items-center h-16 text-sub">
                <a href="#food" class="nav-item-mobile flex flex-col items-center justify-center gap-1 w-full h-full rounded-l-full"><i data-lucide="layout-dashboard"></i><span class="text-xs">Home</span></a>
                <a href="#meal" class="nav-item-mobile flex flex-col items-center justify-center gap-1 w-full h-full"><i data-lucide="utensils-crossed"></i><span class="text-xs">Meal</span></a>
                <a href="#recipes" class="nav-item-mobile flex flex-col items-center justify-center gap-1 w-full h-full"><i data-lucide="notebook-pen"></i><span class="text-xs">Recipes</span></a>
                <a href="#calculator" class="nav-item-mobile flex flex-col items-center justify-center gap-1 w-full h-full rounded-r-full"><i data-lucide="calculator"></i><span class="text-xs">Calculators</span></a>
            </nav>
        </div>
    </footer>
    
    <div id="settings-overlay" class="fixed inset-0 z-50 transform translate-x-full overflow-y-auto"></div>

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 p-4">
        <div class="bg-card border-card rounded-lg p-6 w-full max-w-sm text-center transform transition-transform scale-95 glass-card">
            <h3 id="modal-title" class="text-lg font-bold text-main mb-4">Alert</h3>
            <div id="modal-message" class="text-sub mb-6 text-left"></div>
            <button id="modal-close-btn" class="btn-primary w-full">Close</button>
        </div>
    </div>
    
    <script type="module">
        const apiKeys = ["", "", ""]; 
        let currentApiKeyIndex = 0;

        function setupApp(user) {
            initializeTheme();
            updateUIWithUserData(user);
            setupNavigation();
            renderAllPages(user);
            setupParallax();
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function setupParallax() {
            const parallaxBg = document.getElementById('parallax-bg');
            if (parallaxBg) {
                window.addEventListener('scroll', () => {
                    const offset = window.pageYOffset;
                    parallaxBg.style.transform = `translateY(${offset * 0.3}px)`;
                });
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.className = savedTheme;
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.className = newTheme;
            localStorage.setItem('theme', newTheme);
        }

        function updateUIWithUserData(user) {
            const photoUrl = user.photoURL || `https://placehold.co/96x96/FBBF24/000000?text=${user.displayName ? user.displayName.charAt(0) : 'A'}`;
            document.getElementById('user-avatar').src = photoUrl;
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-item-desktop, .nav-item-mobile');
            const pages = document.querySelectorAll('.page');
            const headerTitle = document.getElementById('header-title');
            const pageTitles = {
                'food': 'Dashboard',
                'meal': 'Meal Analyzer',
                'recipes': 'Recipes & Cravings',
                'calculator': 'Health Calculators'
            };

            const updateActiveState = (pageId) => {
                pageId = pageId || 'food';
                pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                headerTitle.textContent = pageTitles[pageId] || 'Dashboard';
                
                document.querySelectorAll('.nav-item-desktop').forEach(l => l.classList.toggle('active', l.getAttribute('href') === `#${pageId}`));
                document.querySelectorAll('.nav-item-mobile').forEach(l => l.classList.toggle('active', l.getAttribute('href') === `#${pageId}`));
            };

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('href').substring(1);
                    window.location.hash = pageId;
                });
            });

            window.addEventListener('hashchange', () => updateActiveState(window.location.hash.substring(1)));
            updateActiveState(window.location.hash.substring(1));
        }

        function renderAllPages(user) {
            const photoUrl = user.photoURL || `https://placehold.co/96x96/FBBF24/000000?text=${user.displayName ? user.displayName.charAt(0) : 'A'}`;
            const userName = user.displayName || user.email.split('@')[0];
            
            document.getElementById('food').innerHTML = `
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-main">Hello, ${userName}!</h2>
                </div>
                <div class="bg-card border-card p-6 rounded-2xl mb-8 glass-card">
                     <h3 class="text-xl font-bold text-main mb-2">Welcome back!</h3>
                     <p class="text-sub">"The only bad workout is the one that didn't happen."</p>
                </div>
                <div class="bg-card border-card p-6 rounded-2xl glass-card">
                    <div class="flex items-center gap-4 mb-6">
                        <i data-lucide="utensils" class="w-8 h-8 text-primary"></i>
                        <div>
                            <h2 class="text-2xl font-bold text-main">Nutrition Lookup</h2>
                            <p class="text-sub">Search for a food to find its nutrition information.</p>
                        </div>
                    </div>
                    <div class="relative mb-4">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sub"></i>
                        <input id="nutrition-input" type="text" placeholder="E.g., '100g Chicken Breast'" class="input-field w-full border rounded-lg pl-12 pr-4 py-3 focus:ring-2 focus:ring-primary outline-none transition">
                    </div>
                    <button id="get-nutrition-btn" class="btn-primary w-full flex items-center justify-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>Analyze</button>
                    <div id="nutrition-output" class="mt-8"></div>
                </div>`;
            
            document.getElementById('meal').innerHTML = `
                <div class="bg-card border-card p-6 rounded-2xl glass-card">
                    <div class="flex items-center gap-4 mb-6">
                        <i data-lucide="utensils-crossed" class="w-8 h-8 text-primary"></i>
                        <div>
                            <h2 class="text-2xl font-bold text-main">Know Your Meal</h2>
                            <p class="text-sub">Paste a recipe URL or list ingredients to analyze your entire meal.</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <input id="meal-url-input" type="text" placeholder="Paste a recipe URL" class="input-field w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition">
                        <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-card"></div></div><div class="relative flex justify-center"><span class="bg-card px-2 text-sm text-sub">OR</span></div></div>
                        <textarea id="meal-ingredients-input" placeholder="List ingredients and quantities..." class="input-field w-full h-32 border rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary outline-none transition"></textarea>
                        <button id="analyze-meal-btn" class="btn-primary w-full flex items-center justify-center"><i data-lucide="brain-circuit" class="w-5 h-5 mr-2"></i>Analyze Meal</button>
                    </div>
                    <div id="meal-output" class="mt-8"></div>
                </div>`;

            document.getElementById('recipes').innerHTML = `
                <div class="flex items-center gap-4 mb-6">
                    <i data-lucide="notebook-pen" class="w-8 h-8 text-primary"></i>
                    <div>
                        <h2 class="text-2xl font-bold text-main">Recipes & Cravings</h2>
                        <p class="text-sub">Find healthy recipes or alternatives to your cravings.</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-card border-card p-6 rounded-xl glass-card">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-main"><i data-lucide="chef-hat" class="w-6 h-6 mr-3 text-primary"></i>Recipe Generator</h3>
                        <textarea id="recipe-ingredients-input" placeholder="What ingredients do you have?&#10;e.g., chicken breast, broccoli, soy sauce" class="input-field w-full h-32 border rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-primary outline-none transition"></textarea>
                        <button id="generate-recipe-btn" class="btn-primary w-full">Generate Recipe</button>
                    </div>
                    <div class="bg-card border-card p-6 rounded-xl glass-card">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-main"><i data-lucide="cookie" class="w-6 h-6 mr-3 text-primary"></i>Craving Solver</h3>
                        <input id="craving-input" type="text" placeholder="What are you craving? e.g., Pizza" class="input-field w-full border rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-primary outline-none transition">
                        <button id="solve-craving-btn" class="btn-primary w-full">Find Healthy Alternative</button>
                    </div>
                </div>
                <div id="recipe-output" class="mt-8"></div>`;

            document.getElementById('calculator').innerHTML = `<div class="flex items-center gap-4 mb-6"><i data-lucide="calculator" class="w-8 h-8 text-primary"></i><div><h2 class="text-3xl font-bold text-main">Health Calculators</h2><p class="text-sub">A suite of tools to help you track your health metrics.</p></div></div><div id="calculator-accordion" class="space-y-4"></div><div id="scroll-hint" class="hidden text-center mt-8 text-sub animate-bounce"><i data-lucide="arrow-down" class="w-6 h-6 mx-auto"></i><p>Scroll for more</p></div>`;

            document.getElementById('settings-overlay').innerHTML = `
                <div class="flex items-center justify-between p-4 md:p-6 border-b border-card">
                    <h2 class="text-xl font-bold text-main">Profile & Settings</h2>
                    <button id="profile-close-btn" class="p-2 rounded-full hover:bg-card"><i data-lucide="x" class="text-sub"></i></button>
                </div>
                <div class="p-4 md:p-6 space-y-8">
                    <div class="text-center space-y-2 relative">
                        <img src="${photoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/96x96/FBBF24/000000?text=A';" alt="User Avatar" class="w-24 h-24 rounded-full object-cover border-4 border-primary mx-auto">
                        <h3 class="text-2xl font-bold text-main pt-2">${userName}</h3>
                        <p class="text-sub">${user.email}</p>
                    </div>

                    <div class="space-y-4">
                        <h4 class="font-bold text-sub px-1 text-sm uppercase tracking-wider">Settings</h4>
                        <div class="flex justify-between items-center p-4 bg-card border-card border rounded-lg glass-card">
                            <div class="flex items-center">
                                <i data-lucide="sun" class="w-5 h-5 mr-4 text-sub"></i>
                                <span class="text-main">Theme</span>
                            </div>
                            <button id="theme-toggle-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-400">
                                <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" id="theme-toggle-indicator"></span>
                            </button>
                        </div>
                    </div>

                     <div class="space-y-2">
                         <h4 class="font-bold text-sub px-1 text-sm uppercase tracking-wider">Manage</h4>
                         <a href="#" class="flex justify-between items-center p-4 bg-card border-card border rounded-lg hover:border-primary transition glass-card"><div class="flex items-center"><i data-lucide="user-cog" class="w-5 h-5 mr-4 text-sub"></i><span class="text-main">Account</span></div><i data-lucide="chevron-right" class="w-5 h-5 text-sub"></i></a>
                         <button id="signout-btn" class="w-full flex items-center p-4 bg-card border-card border rounded-lg hover:border-red-500/50 transition text-red-500 font-semibold"><i data-lucide="log-out" class="w-5 h-5 mr-4"></i>Sign Out</button>
                     </div>
                    <footer class="text-center mt-12 text-sub text-sm">Made with ❤️ by <a href="https://www.instagram.com/ashutosh8877" target="_blank" class="text-primary font-bold hover:underline">Ashutosh</a></footer>
                </div>`;
            
            document.getElementById('profile-close-btn').addEventListener('click', () => {
                document.getElementById('settings-overlay').classList.add('translate-x-full');
                document.body.classList.remove('overflow-hidden');
            });
            document.getElementById('profile-avatar-btn').addEventListener('click', () => {
                document.getElementById('settings-overlay').classList.remove('translate-x-full');
                document.body.classList.add('overflow-hidden');
            });
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            document.getElementById('theme-toggle-btn').addEventListener('click', () => {
                toggleTheme();
                updateThemeToggleUI();
            });
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            updateThemeToggleUI();

            setupFeatureLogic();
        }

        function updateThemeToggleUI() {
            const isDark = document.documentElement.classList.contains('dark');
            const toggleBtn = document.getElementById('theme-toggle-btn');
            const indicator = document.getElementById('theme-toggle-indicator');
            const themeIcon = document.querySelector('#settings-overlay i[data-lucide="sun"], #settings-overlay i[data-lucide="moon"]');
            
            if (isDark) {
                toggleBtn.classList.remove('bg-gray-400');
                toggleBtn.classList.add('bg-primary');
                indicator.style.transform = 'translateX(1.25rem)';
                if(themeIcon) themeIcon.setAttribute('data-lucide', 'moon');
            } else {
                toggleBtn.classList.add('bg-gray-400');
                toggleBtn.classList.remove('bg-primary');
                indicator.style.transform = 'translateX(0.125rem)';
                if(themeIcon) themeIcon.setAttribute('data-lucide', 'sun');
            }
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function setupFeatureLogic() {
            const calculators = [
                { id: 'bmi', name: 'BMI Calculator', icon: 'ruler', fields: [{id: 'height', placeholder: 'Height (cm)', type: 'number'}, {id: 'weight', placeholder: 'Weight (kg)', type: 'number'}], func: 'calculateBMI' },
                { id: 'bmr', name: 'BMR Calculator', icon: 'flame', fields: [{id: 'age', placeholder: 'Age', type: 'number'}, {id: 'gender', type: 'select', options: ['Male', 'Female']}, {id: 'height', placeholder: 'Height (cm)', type: 'number'}, {id: 'weight', placeholder: 'Weight (kg)', type: 'number'}], func: 'calculateBMR' },
                { id: 'bf', name: 'Body Fat Calculator', icon: 'percent', fields: [{id: 'gender', type: 'select', options: ['Male', 'Female']}, {id: 'height', placeholder: 'Height (cm)', type: 'number'}, {id: 'weight', placeholder: 'Weight (kg)', type: 'number'}, {id: 'neck', placeholder: 'Neck (cm)', type: 'number'}, {id: 'waist', placeholder: 'Waist (cm)', type: 'number'}, {id: 'hip', placeholder: 'Hip (cm) (Females)', type: 'number'}], func: 'calculateBodyFat' },
                { id: 'iw', name: 'Ideal Weight Calculator', icon: 'target', fields: [ {id: 'gender', type: 'select', options: ['Male', 'Female']}, {id: 'height', placeholder: 'Height (cm)', type: 'number'} ], func: 'calculateIdealWeight' },
                { id: 'lbm', name: 'Lean Body Mass Calculator', icon: 'bone', fields: [ {id: 'gender', type: 'select', options: ['Male', 'Female']}, {id: 'height', placeholder: 'Height (cm)', type: 'number'}, {id: 'weight', placeholder: 'Weight (kg)', type: 'number'} ], func: 'calculateLBM' },
                { id: 'ov', name: 'Ovulation Calculator', icon: 'calendar-heart', fields: [ {id: 'last-period', placeholder: 'First Day of Last Period', type: 'date'}, {id: 'cycle-length', placeholder: 'Avg. Cycle Length', type: 'number', value: 28} ], func: 'calculateOvulation' },
            ];
            const accordionContainer = document.getElementById('calculator-accordion');
            if(accordionContainer) {
                accordionContainer.innerHTML = calculators.map(calc => `
                    <div class="accordion-item border rounded-lg glass-card"><button class="accordion-header w-full text-left p-4 font-semibold text-lg flex justify-between items-center transition-colors hover:text-primary text-main"><span class="flex items-center"><i data-lucide="${calc.icon}" class="w-5 h-5 mr-3"></i> ${calc.name}</span><i data-lucide="chevron-down" class="transform transition-transform text-sub"></i></button><div class="accordion-content px-4 pb-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">${calc.fields.map(f => f.type === 'select' ? `<select id="${calc.id}-${f.id}" class="input-field w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-primary transition text-main">${f.options.map(o => `<option value="${o.toLowerCase()}">${o}</option>`).join('')}</select>` : `<input type="${f.type === 'date' ? 'text' : f.type}" onfocus="${f.type === 'date' ? "(this.type='date')" : ''}" onblur="${f.type === 'date' ? "(this.type='text')" : ''}" id="${calc.id}-${f.id}" placeholder="${f.placeholder}" ${f.value ? `value="${f.value}"` : ''} class="input-field w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-primary transition text-main">`).join('')}</div><button data-func="${calc.func}" class="calculator-btn mt-4 btn-primary">Calculate</button></div></div>`).join('');
                
                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const accordionItem = header.parentElement;
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('i[data-lucide="chevron-down"]');
                        const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';

                        accordionItem.parentElement.querySelectorAll('.accordion-item').forEach(item => {
                            if (item !== accordionItem) {
                                item.querySelector('.accordion-content').style.maxHeight = null;
                                const otherIcon = item.querySelector('i[data-lucide="chevron-down"]');
                                if(otherIcon) otherIcon.classList.remove('rotate-180');
                            }
                        });

                        if (isOpen) {
                            content.style.maxHeight = null;
                            if(icon) icon.classList.remove('rotate-180');
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            if(icon) icon.classList.add('rotate-180');
                        }
                    });
                });
                
                document.querySelectorAll('.calculator-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const funcName = e.target.dataset.func;
                        if(window[funcName]) {
                            window[funcName]();
                        }
                    });
                });

                checkScrollHint();
                window.addEventListener('resize', checkScrollHint);
            }
            
            const getNutritionBtn = document.getElementById('get-nutrition-btn');
            const nutritionInput = document.getElementById('nutrition-input');
            const nutritionOutput = document.getElementById('nutrition-output');
            const handleGetNutrition = async () => {
                if (!nutritionInput.value.trim()) return;
                setLoadingState(getNutritionBtn, true, 'Analyzing...');
                nutritionOutput.innerHTML = getSkeletonHTML('nutrition');
                const prompt = `Analyze nutrition for "${nutritionInput.value}". Return ONLY a JSON object with keys: foodItem, servingSize, calories (number), totalFat, saturatedFat, transFat, cholesterol, sodium, totalCarbohydrate, dietaryFiber, totalSugars, protein, vitaminD, calcium, iron, potassium. Use "N/A" for unknowns.`;
                const result = await callGeminiApi(prompt);
                if (result) {
                    try {
                        const jsonData = JSON.parse(result.match(/\{[\s\S]*\}/)[0]);
                        nutritionOutput.innerHTML = renderNutritionLabel(jsonData); 
                    } catch(e) { nutritionOutput.innerHTML = `<p class="text-red-400 text-center">Could not parse nutrition data. Try a more specific query.</p>`; }
                } else { nutritionOutput.innerHTML = `<p class="text-red-400 text-center">Could not retrieve nutrition data. Please try again.</p>`; }
                setLoadingState(getNutritionBtn, false, `<i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>Analyze`);
            };
            getNutritionBtn.addEventListener('click', handleGetNutrition);
            nutritionInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleGetNutrition());

            const analyzeMealBtn = document.getElementById('analyze-meal-btn');
            const mealOutput = document.getElementById('meal-output');
            analyzeMealBtn.addEventListener('click', async () => {
                const url = document.getElementById('meal-url-input').value.trim();
                const ingredients = document.getElementById('meal-ingredients-input').value.trim();
                if (!url && !ingredients) return;
                setLoadingState(analyzeMealBtn, true, 'Analyzing...');
                mealOutput.innerHTML = getSkeletonHTML('meal');
                const mealInput = url ? `URL: ${url}` : `Ingredients: ${ingredients}`;
                const prompt = `Analyze this meal: ${mealInput}. Return ONLY a JSON object with two top-level keys: "nutrition" (containing a detailed nutrition facts object) and "suggestions" (an object with "taste" and "health" string properties).`;
                const result = await callGeminiApi(prompt);
                if (result) {
                    try {
                        const data = JSON.parse(result.match(/\{[\s\S]*\}/)[0]);
                        let html = renderNutritionLabel(data.nutrition, 'Total Meal Nutrition');
                        html += `<div class="mt-8 bg-card p-6 rounded-xl border border-card glass-card"><h3 class="text-xl font-semibold mb-4 flex items-center text-main"><i data-lucide="lightbulb" class="w-6 h-6 mr-3 text-primary"></i>AI Suggestions</h3><div class="space-y-4"><div><h4 class="font-bold text-primary">Taste Improvement:</h4><p class="text-sub">${data.suggestions.taste}</p></div><div><h4 class="font-bold text-green-400">Health Improvement:</h4><p class="text-sub">${data.suggestions.health}</p></div></div></div>`;
                        mealOutput.innerHTML = html;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    } catch(e) { mealOutput.innerHTML = `<p class="text-red-400 text-center">Could not parse the meal analysis.</p>`; }
                } else { mealOutput.innerHTML = `<p class="text-red-400 text-center">Could not analyze the meal.</p>`; }
                setLoadingState(analyzeMealBtn, false, `<i data-lucide="brain-circuit" class="w-5 h-5 mr-2"></i> Analyze Meal`);
            });
            
            const recipeOutput = document.getElementById('recipe-output');
            const setupRecipeButton = (btnId, inputId, promptFn) => {
                const btn = document.getElementById(btnId);
                btn.addEventListener('click', async () => {
                    const input = document.getElementById(inputId).value.trim();
                    if (!input) return;
                    const originalText = btn.innerHTML;
                    setLoadingState(btn, true, 'Generating...');
                    recipeOutput.innerHTML = getSkeletonHTML('recipe');
                    const result = await callGeminiApi(promptFn(input));
                    if (result) { recipeOutput.innerHTML = `<div class="bg-card border-card border p-6 rounded-xl ai-content glass-card">${formatAiText(result)}</div>`; } 
                    else { recipeOutput.innerHTML = `<p class="text-red-400 text-center">Could not generate a response. Please try again.</p>`; }
                    setLoadingState(btn, false, originalText);
                });
            };
            setupRecipeButton('generate-recipe-btn', 'recipe-ingredients-input', (i) => `Create a healthy recipe using: ${i}. Use markdown: '### Title', '### Ingredients', '### Instructions'. Use '*' for lists.`);
            setupRecipeButton('solve-craving-btn', 'craving-input', (c) => `I'm craving ${c}. Suggest a healthy alternative recipe. Use markdown: '### Title', '### Why Healthier', '### Ingredients', '### Instructions'. Use '*' for lists.`);
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        async function callGeminiApi(prompt, retries = apiKeys.length) {
            const apiKey = apiKeys[currentApiKeyIndex];
            if (!apiKey) {
                showModal("API Key Not Found", "The Gemini API key is not set. Please add it to the script to enable AI features.");
                return null;
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const data = await response.json();
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content.parts.length > 0) {
                    return data.candidates[0].content.parts[0].text;
                }
                throw new Error("No content returned from API.");
            } catch (error) {
                console.error(`API Error with key index ${currentApiKeyIndex}:`, error);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                if (retries > 1) {
                    console.log(`Retrying with new API key index ${currentApiKeyIndex}...`);
                    return callGeminiApi(prompt, retries - 1);
                } else {
                    showModal("API Error", "All API keys failed. Please check your keys and the browser console.");
                    return null;
                }
            }
        }
        
        function checkScrollHint() {
            const calcPage = document.getElementById('calculator');
            const scrollHint = document.getElementById('scroll-hint');
            if (calcPage && scrollHint) {
                const isScrollable = calcPage.scrollHeight > calcPage.clientHeight;
                scrollHint.classList.toggle('hidden', !isScrollable);
            }
        }

        const renderNutritionLabel = (data) => `<div class="nutrition-label glass-card"><div class="header"><h1 class="capitalize text-main">${data.foodItem||'N/A'}</h1><div class="text-sub">Serving Size ${data.servingSize||'N/A'}</div></div><div class="item"><span class="text-main">Calories</span> <span class="text-2xl font-bold text-main">${data.calories??'N/A'}</span></div><div class="item"><span class="text-main">Total Fat</span> <span class="text-main">${data.totalFat||'N/A'}</span></div><div class="item indent"><span class="text-sub">Saturated Fat</span> <span class="text-sub">${data.saturatedFat||'N/A'}</span></div><div class="item indent"><span class="text-sub">Trans Fat</span> <span class="text-sub">${data.transFat||'N/A'}</span></div><div class="item"><span class="text-main">Cholesterol</span> <span class="text-main">${data.cholesterol||'N/A'}</span></div><div class="item"><span class="text-main">Sodium</span> <span class="text-main">${data.sodium||'N/A'}</span></div><div class="item"><span class="text-main">Total Carbohydrate</span> <span class="text-main">${data.totalCarbohydrate||'N/A'}</span></div><div class="item indent"><span class="text-sub">Dietary Fiber</span> <span class="text-sub">${data.dietaryFiber||'N/A'}</span></div><div class="item indent"><span class="text-sub">Total Sugars</span> <span class="text-sub">${data.totalSugars||'N/A'}</span></div><div class="item"><span class="text-main">Protein</span> <span class="text-main">${data.protein||'N/A'}</span></div><div class="footer"><div class="item"><span class="text-main">Vitamin D</span> <span class="text-main">${data.vitaminD||'N/A'}</span></div><div class="item"><span class="text-main">Calcium</span> <span class="text-main">${data.calcium||'N/A'}</span></div><div class="item"><span class="text-main">Iron</span> <span class="text-main">${data.iron||'N/A'}</span></div><div class="item"><span class="text-main">Potassium</span> <span class="text-main">${data.potassium||'N/A'}</span></div></div></div>`;
        const getSkeletonHTML = (type) => {
            if (type === 'nutrition' || type === 'meal') {
                return `<div class="nutrition-label glass-card skeleton"><div class="header"><div class="skeleton-title bg-gray-700 rounded"></div><div class="skeleton-line w-1/3 mt-2 bg-gray-700 rounded"></div></div><div class="space-y-4 mt-4"><div class="skeleton-line bg-gray-700 rounded"></div><div class="skeleton-line bg-gray-700 rounded"></div><div class="skeleton-line w-2/3 bg-gray-700 rounded ml-6"></div><div class="skeleton-line w-1/2 bg-gray-700 rounded"></div></div></div>`;
            }
            if (type === 'recipe') {
                return `<div class="bg-card border-card border p-6 rounded-xl glass-card skeleton"><div class="space-y-4"><div class="skeleton-title bg-gray-700 rounded"></div><div class="skeleton-line bg-gray-700 rounded"></div><div class="skeleton-line w-5/6 bg-gray-700 rounded"></div><div class="skeleton-line w-2/3 bg-gray-700 rounded"></div></div></div>`;
            }
            return '';
        };
        const formatAiText = (text) => text.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^\* (.*$)/gim, '<li>$1</li>').replace(/<\/li><li>/g, '</li></ul><ul><li>').replace(/<\/li>([^<])/g, '</li></ul>$1').replace(/^<li>/g, '<ul><li>').replace(/<\/li>$/g, '</li></ul>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>').replace(/<br><ul>/g, '<ul>').replace(/<\/ul><br>/g, '</ul>').replace(/\*|#|\*\*\*/g, '');

        const modal = document.getElementById('custom-modal');
        function showModal(title, messageHTML) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = messageHTML;
            modal.classList.add('show');
            setTimeout(() => modal.querySelector('div').classList.add('scale-100'), 10);
        }
        function hideModal() {
            modal.querySelector('div').classList.remove('scale-100');
            setTimeout(() => modal.classList.remove('show'), 200);
        }
        
        window.calculateBMI = () => { const h=document.getElementById('bmi-height').value, w=document.getElementById('bmi-weight').value; if(h>0&&w>0){ const bmi=(w/((h/100)**2)).toFixed(1); let c=''; if(bmi<18.5)c='Underweight'; else if(bmi<25)c='Normal'; else if(bmi<30)c='Overweight'; else c='Obesity'; showModal('BMI Result', `<p class="text-2xl font-bold text-center">${bmi}</p><p class="text-sub text-center">${c}</p>`); } else { showModal('Error', `<p class="text-red-400 text-center">Please enter valid values.</p>`); } };
        window.calculateBMR = () => { const a=document.getElementById('bmr-age').value, g=document.getElementById('bmr-gender').value, h=document.getElementById('bmr-height').value, w=document.getElementById('bmr-weight').value; if(a>0&&h>0&&w>0){ let bmr=g==='male'?(88.362+(13.397*w)+(4.799*h)-(5.677*a)):(447.593+(9.247*w)+(3.098*h)-(4.330*a)); showModal('BMR Result', `<p class="text-2xl font-bold text-center">${bmr.toFixed(0)}</p><p class="text-sub text-center">calories/day</p>`); } else { showModal('Error', `<p class="text-red-400 text-center">Please fill all fields.</p>`); } };
        window.calculateBodyFat = () => { const g=document.getElementById('bf-gender').value, h=document.getElementById('bf-height').value, w=document.getElementById('bf-weight').value, n=document.getElementById('bf-neck').value, wa=document.getElementById('bf-waist').value, hi=document.getElementById('bf-hip').value; if(h<=0||w<=0||n<=0||wa<=0){showModal('Error', `<p class="text-red-400 text-center">Fill required fields.</p>`); return;} let bfp=0; if(g==='male'){bfp=495/(1.0324-0.19077*Math.log10(wa-n)+0.15456*Math.log10(h))-450;}else{if(hi<=0){showModal('Error', `<p class="text-red-400 text-center">Hip measurement is required for females.</p>`); return;} bfp=495/(1.29579-0.35004*Math.log10(parseFloat(wa)+parseFloat(hi)-n)+0.22100*Math.log10(h))-450;} if(bfp>0&&bfp<100){showModal('Body Fat Result', `<p class="text-2xl font-bold text-center">${bfp.toFixed(1)}%</p><p class="text-sub text-center">Body Fat</p>`);}else{showModal('Error', `<p class="text-red-400 text-center">Could not calculate based on measurements.</p>`);} };
        window.calculateIdealWeight = () => { const g=document.getElementById('iw-gender').value, h=document.getElementById('iw-height').value; if(h<=152){showModal('Error', `<p class="text-red-400 text-center">Height must be greater than 152cm.</p>`); return;} let base=g==='male'?50:45.5; const iw=base+(((h/2.54)-60)*2.3); showModal('Ideal Weight Result', `<p class="text-2xl font-bold text-center">${iw.toFixed(1)} kg</p>`); };
        window.calculateLBM = () => { const g=document.getElementById('lbm-gender').value, h=document.getElementById('lbm-height').value, w=document.getElementById('lbm-weight').value; if(h<=0||w<=0){showModal('Error', `<p class="text-red-400 text-center">Please enter valid values.</p>`); return;} let lbm = g==='male'?(0.407*w)+(0.267*h)-19.2:(0.252*w)+(0.473*h)-48.3; showModal('Lean Body Mass Result', `<p class="text-2xl font-bold text-center">${lbm.toFixed(1)} kg</p>`); };
        window.calculateOvulation = () => { const dStr=document.getElementById('ov-last-period').value, c=parseInt(document.getElementById('ov-cycle-length').value); if(!dStr||isNaN(c)||c<20||c>45){showModal('Error', `<p class="text-red-400 text-center">Please enter a valid date and cycle length.</p>`); return;} const d=new Date(dStr.replace(/-/g, '\/')); const o=new Date(d); o.setDate(d.getDate()+c-14); const fs=new Date(o); fs.setDate(o.getDate()-5); const fe=new Date(o); fe.setDate(o.getDate()+1); const fDate=(dt)=>dt.toLocaleDateString('en-US',{month:'long',day:'numeric'}); showModal('Ovulation Estimate', `<p class="font-bold text-primary text-center">${fDate(o)}</p><p class="text-sub text-center">Estimated Ovulation Date</p><p class="font-bold mt-4 text-center">${fDate(fs)} - ${fDate(fe)}</p><p class="text-sub text-center">Fertile Window</p>`); };
        
        async function handleGoogleSignIn() {
            const provider = new window.GoogleAuthProvider();
            try {
                const result = await window.signInWithPopup(window.auth, provider);
                const user = result.user;
                
                const userRef = window.doc(window.db, "users", user.uid);
                const userSnap = await window.getDoc(userRef);
                if (!userSnap.exists()) {
                    await window.setDoc(userRef, {
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        createdAt: new Date()
                    });
                }
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showModal("Sign-In Error", error.message);
            }
        }
        
        function handleSignOut() {
            window.signOut(window.auth).catch(error => {
                console.error("Sign Out Error:", error);
                showModal("Error", "Could not sign out. Please try again.");
            });
        }

        window.onload = () => {
            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            
            lucide.createIcons();
        };
    </script>
</body>
</html>
