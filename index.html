<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calverse - Nutrition & Fitness</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #F9FAFB; /* text-gray-50 */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        /* Sidebar active link */
        .sidebar-link.active {
            background-color: #FBBF24; /* bg-yellow-400 */
            color: #111827;
        }
        .sidebar-link.active i { color: #111827; }

        /* Hide sections by default */
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* FAB halo effect */
        .fab-halo { box-shadow: 0 0 20px 5px rgba(251, 191, 36, 0.5); }

        /* Nutrition Label Styles */
        .nutrition-label { font-family: 'Inter', sans-serif; }
        .nutrition-label .header { font-size: 2.2rem; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 2px; }
        .nutrition-label .line { border-top: 10px solid #374151; }
        .nutrition-label .line.thin { border-top-width: 1px; }
        .nutrition-label .line.medium { border-top-width: 5px; }
        .nutrition-label .item { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 2px; }
        .nutrition-label .item .name { font-weight: 700; }
        .nutrition-label .item .dv { font-weight: 700; text-align: right; }
        .nutrition-label .item .sub-item { margin-left: 1.5rem; }

        /* Accordion animation */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-auto">
            <i class="fas fa-leaf text-yellow-400 text-5xl mb-4"></i>
            <h1 class="text-3xl font-bold mb-2">Welcome to Calverse</h1>
            <p class="text-gray-400 mb-6">Your AI-powered nutrition and fitness companion.</p>
            <button id="google-login-btn" class="w-full bg-yellow-400 text-gray-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-yellow-500 transition-all duration-300">
                <i class="fab fa-google"></i>
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>

    <!-- Main App Structure (hidden until login) -->
    <div id="app-container" class="flex h-full w-full hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-gray-800 text-gray-200 w-20 lg:w-64 flex-shrink-0 flex flex-col items-center lg:items-start p-4 space-y-6 transition-all duration-300">
            <div class="flex items-center justify-center lg:justify-start w-full mb-8">
                <i class="fas fa-leaf text-yellow-400 text-3xl"></i>
                <span class="hidden lg:inline text-2xl font-bold ml-3">Calverse</span>
            </div>
            <nav class="flex flex-col space-y-4 w-full">
                <a href="#" data-section="nutrition" class="sidebar-link active flex items-center justify-center lg:justify-start p-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-utensils w-6 text-center text-xl"></i><span class="hidden lg:inline ml-4 font-semibold">Food</span>
                </a>
                <a href="#" data-section="meal" class="sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-plate-wheat w-6 text-center text-xl"></i><span class="hidden lg:inline ml-4 font-semibold">Know Your Meal</span>
                </a>
                <a href="#" data-section="recipe" class="sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-lightbulb w-6 text-center text-xl"></i><span class="hidden lg:inline ml-4 font-semibold">Recipe Ideas</span>
                </a>
                <a href="#" data-section="calculators" class="sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-calculator w-6 text-center text-xl"></i><span class="hidden lg:inline ml-4 font-semibold">Calculators</span>
                </a>
                <a href="#" data-section="settings" class="sidebar-link flex items-center justify-center lg:justify-start p-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-cog w-6 text-center text-xl"></i><span class="hidden lg:inline ml-4 font-semibold">Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-y-auto">
            <!-- Header -->
            <header class="sticky top-0 bg-gray-900 bg-opacity-80 backdrop-blur-md z-30 flex items-center justify-between p-4 border-b border-gray-700">
                <h1 id="page-title" class="text-xl font-bold">Food</h1>
                <div class="relative">
                    <button id="profile-button" class="flex items-center space-x-2">
                        <img id="user-avatar" src="https://placehold.co/40x40/FBBF24/111827?text=U" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-yellow-400">
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-40">
                        <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Logout</a>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div id="content-area" class="flex-1 p-4 sm:p-6 lg:p-8">
                <!-- Nutrition Section -->
                <section id="nutrition-section" class="content-section active">
                    <div class="max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold mb-4">Nutrition Analysis</h2>
                        <div class="relative mb-4">
                            <input type="text" id="nutrition-search" placeholder="e.g., '100g soya chunks' or '2 medium eggs'" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none focus:border-yellow-400 transition-colors">
                            <button id="analyze-nutrition-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-yellow-400 text-gray-900 px-4 py-1.5 rounded-md font-semibold hover:bg-yellow-500 transition-colors">Analyze</button>
                        </div>
                        <div id="nutrition-label-container" class="bg-gray-800 border-4 border-gray-600 p-4 rounded-lg max-w-sm mx-auto mt-8"></div>
                    </div>
                </section>

                <!-- Know Your Meal Section -->
                <section id="meal-section" class="content-section">
                    <h2 class="text-2xl font-bold mb-4">Know Your Meal</h2>
                    <!-- ... content ... -->
                </section>

                <!-- Recipe Suggestion Section -->
                <section id="recipe-section" class="content-section">
                    <h2 class="text-2xl font-bold mb-4">Recipe Suggestions</h2>
                    <!-- ... content ... -->
                </section>

                <!-- Calculators Section -->
                <section id="calculators-section" class="content-section">
                    <h2 class="text-2xl font-bold mb-4">Health Calculators</h2>
                    <div class="max-w-2xl mx-auto space-y-2" id="calculator-accordion"></div>
                </section>

                <!-- Settings/Profile Section -->
                <section id="settings-section" class="content-section">
                    <h2 class="text-2xl font-bold mb-4">Profile & Settings</h2>
                    <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-auto">
                        <p class="text-gray-400">User ID:</p>
                        <p id="user-id-display" class="font-mono text-yellow-400 mb-4"></p>
                        <p class="text-gray-400">Display Name:</p>
                        <p id="user-name-display" class="text-lg font-semibold mb-4"></p>
                        <p class="text-gray-400">Email:</p>
                        <p id="user-email-display" class="text-lg font-semibold"></p>
                    </div>
                </section>
            </div>

            <!-- Footer -->
            <footer class="sticky bottom-0 bg-gray-900 p-3 text-center text-gray-400 text-sm border-t border-gray-700 z-20">
                Made with <i class="fas fa-heart text-red-500"></i> by Ashutosh Roy
            </footer>
        </main>

        <!-- FAB -->
        <button id="fab" class="hidden fixed bottom-20 right-8 bg-yellow-400 text-gray-900 w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg fab-halo hover:bg-yellow-500 transition-all duration-300 z-20">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCu5RfnRhT9refiyybPcW_IBt_7l5cgt2I",
            authDomain: "calverse-e3cdb.firebaseapp.com",
            projectId: "calverse-e3cdb",
            storageBucket: "calverse-e3cdb.appspot.com",
            messagingSenderId: "284415302963",
            appId: "1:284415302963:web:936ad62e589bad6fc9b246"
        };

        const GEMINI_API_KEYS = [
            "AIzaSyCiPL-DcZN82CxH6OmYv9Ll4yM3WiVjxXY",
            "AIzaSyAvU63lMyAjbSJfcTBuBnkZQ0DPoBpm6Ho",
            "AIzaSyAIJZmqyztvwoThqI7iu2-xzQr71aJaKEU",
            "AIzaSyAmbO3Szmr9vAj24MkRkbMQeQi1j7_-m4Y"
        ];
        let currentApiKeyIndex = 0;

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(err => console.error("Firebase persistence error: ", err));

        // --- DOM ELEMENTS ---
        const loginModal = document.getElementById('login-modal');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutButton = document.getElementById('logout-button');
        const profileButton = document.getElementById('profile-button');
        const profileDropdown = document.getElementById('profile-dropdown');
        const userAvatar = document.getElementById('user-avatar');
        const pageTitle = document.getElementById('page-title');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.content-section');
        const fab = document.getElementById('fab');
        const nutritionSearchInput = document.getElementById('nutrition-search');
        const analyzeNutritionBtn = document.getElementById('analyze-nutrition-btn');
        const nutritionLabelContainer = document.getElementById('nutrition-label-container');
        const calculatorAccordionContainer = document.getElementById('calculator-accordion');

        // --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                loginModal.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await setupUser(user);
                updateUIForUser(user);
                initApp();
            } else {
                // User is signed out
                loginModal.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Authentication error:", error);
                alert("Could not sign in. Please try again.");
            }
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });
        
        const setupUser = async (user) => {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                const randomPart = Math.random().toString(36).substring(2, 8);
                const customId = `${user.displayName.substring(0, 3).toLowerCase()}${randomPart}`;
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: new Date(),
                    customId: customId
                });
            }
        };
        
        const updateUIForUser = async (user) => {
            userAvatar.src = user.photoURL || `https://placehold.co/40x40/FBBF24/111827?text=${user.displayName[0]}`;
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            if(userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('user-id-display').textContent = userData.customId;
                document.getElementById('user-name-display').textContent = userData.displayName;
                document.getElementById('user-email-display').textContent = userData.email;
            }
        };

        // --- UI & NAVIGATION LOGIC ---
        function initApp() {
            profileButton.addEventListener('click', () => profileDropdown.classList.toggle('hidden'));
            window.addEventListener('click', (e) => {
                if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    contentSections.forEach(s => s.classList.remove('active'));
                    document.getElementById(`${section}-section`).classList.add('active');
                    pageTitle.textContent = link.querySelector('span').textContent;
                    fab.classList.toggle('hidden', section !== 'settings');
                });
            });

            // Initialize calculators
            buildCalculators();
        }
        
        // --- GEMINI API LOGIC ---
        async function callGemini(prompt) {
            const apiKey = GEMINI_API_KEYS[currentApiKeyIndex];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;

            } catch (error) {
                console.error("Gemini API call failed:", error);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % GEMINI_API_KEYS.length;
                console.log(`Switched to API key index ${currentApiKeyIndex}`);
                if (currentApiKeyIndex !== 0) { // Avoid infinite loops
                    return callGemini(prompt); // Retry with the next key
                } else {
                    return JSON.stringify({ error: "All API keys failed. Please try again later." });
                }
            }
        }
        
        // --- NUTRITION ANALYSIS ---
        analyzeNutritionBtn.addEventListener('click', async () => {
            const query = nutritionSearchInput.value.trim();
            if (!query) return;

            nutritionLabelContainer.innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-spinner fa-spin text-yellow-400 text-4xl"></i>
                    <p class="mt-2 text-lg">Analyzing with Gemini...</p>
                </div>`;
            
            const prompt = `Analyze the nutrition for "${query}". Return a JSON object with the following structure, using FDA guidelines. If a value is not applicable or zero, use 0. Do not use strings for numeric values.
            {
              "itemName": "Name of the food",
              "servingSize": "e.g., 1 cup (240g)",
              "calories": 150,
              "totalFat": {"value": 5, "dv": 6},
              "saturatedFat": {"value": 1, "dv": 5},
              "transFat": {"value": 0, "dv": null},
              "cholesterol": {"value": 0, "dv": 0},
              "sodium": {"value": 160, "dv": 7},
              "totalCarbohydrate": {"value": 30, "dv": 11},
              "dietaryFiber": {"value": 4, "dv": 14},
              "totalSugars": {"value": 1, "dv": null},
              "addedSugars": {"value": 0, "dv": 0},
              "protein": {"value": 3, "dv": 6},
              "vitaminD": {"value": 2, "dv": 10},
              "calcium": {"value": 260, "dv": 20},
              "iron": {"value": 8, "dv": 45},
              "potassium": {"value": 2350, "dv": 50}
            }`;

            const resultText = await callGemini(prompt);
            try {
                const jsonString = resultText.match(/```json\n([\s\S]*?)\n```/)[1];
                const data = JSON.parse(jsonString);
                renderNutritionLabel(data);
            } catch (e) {
                console.error("Error parsing Gemini response:", e, resultText);
                nutritionLabelContainer.innerHTML = `<p class="text-red-400 text-center">Sorry, I couldn't understand the nutrition data. Please try a different query.</p>`;
            }
        });

        function renderNutritionLabel(data) {
            if (data.error) {
                nutritionLabelContainer.innerHTML = `<p class="text-red-400 text-center">${data.error}</p>`;
                return;
            }

            const html = `
                <div class="nutrition-label text-gray-50">
                    <h1 class="header">Nutrition Facts</h1>
                    <div class="line"></div>
                    <p class="font-semibold">Serving Size <span class="float-right">${data.servingSize || 'N/A'}</span></p>
                    <div class="line medium"></div>
                    <div class="item">
                        <span class="name">Calories</span>
                        <span class="font-bold text-2xl">${data.calories || 0}</span>
                    </div>
                    <div class="line"></div>
                    <div class="item"><span class="name"></span><span class="dv">% Daily Value*</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="name">Total Fat</span> ${data.totalFat?.value || 0}g <span class="dv">${data.totalFat?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="sub-item">Saturated Fat</span> ${data.saturatedFat?.value || 0}g <span class="dv">${data.saturatedFat?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="sub-item"><i>Trans</i> Fat</span> ${data.transFat?.value || 0}g <span class="dv"></span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="name">Cholesterol</span> ${data.cholesterol?.value || 0}mg <span class="dv">${data.cholesterol?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="name">Sodium</span> ${data.sodium?.value || 0}mg <span class="dv">${data.sodium?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="name">Total Carbohydrate</span> ${data.totalCarbohydrate?.value || 0}g <span class="dv">${data.totalCarbohydrate?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="sub-item">Dietary Fiber</span> ${data.dietaryFiber?.value || 0}g <span class="dv">${data.dietaryFiber?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="sub-item">Total Sugars</span> ${data.totalSugars?.value || 0}g <span class="dv"></span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="sub-item" style="padding-left: 2rem;">Includes ${data.addedSugars?.value || 0}g Added Sugars</span><span class="dv">${data.addedSugars?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span class="name">Protein</span> ${data.protein?.value || 0}g <span class="dv">${data.protein?.dv || 0}%</span></div>
                    <div class="line medium"></div>
                    <div class="item"><span>Vitamin D</span> ${data.vitaminD?.value || 0}mcg <span class="dv">${data.vitaminD?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span>Calcium</span> ${data.calcium?.value || 0}mg <span class="dv">${data.calcium?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span>Iron</span> ${data.iron?.value || 0}mg <span class="dv">${data.iron?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <div class="item"><span>Potassium</span> ${data.potassium?.value || 0}mg <span class="dv">${data.potassium?.dv || 0}%</span></div>
                    <div class="line thin"></div>
                    <p class="text-xs mt-2">*The % Daily Value (DV) tells you how much a nutrient in a serving of food contributes to a daily diet. 2,000 calories a day is used for general nutrition advice.</p>
                </div>
            `;
            nutritionLabelContainer.innerHTML = html;
        }

        // --- CALCULATORS ---
        const calculators = [
            { name: 'BMI Calculator', id: 'bmi' },
            { name: 'BMR Calculator', id: 'bmr' },
            { name: 'Ideal Weight', id: 'ideal-weight' },
        ];

        function buildCalculators() {
            calculatorAccordionContainer.innerHTML = calculators.map(calc => `
                <div class="bg-gray-800 rounded-lg">
                    <button class="accordion-header w-full flex justify-between items-center p-4 font-semibold text-left">
                        <span>${calc.name}</span>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="accordion-content px-4 pb-4">
                        <!-- Content for ${calc.id} will be here -->
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('i');
                    
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.classList.remove('rotate-180');
                    } else {
                        // Close other accordions
                        document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                        document.querySelectorAll('.accordion-header i').forEach(i => i.classList.remove('rotate-180'));
                        
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                });
            });
        }
    </script>
</body>
</html>
