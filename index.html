<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calverse - AI Nutrition & Health</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f9fafb; /* text-gray-50 */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .profile-drawer {
            transition: transform 0.3s ease-in-out;
        }
        .nutrition-label {
            border: 2px solid #4b5563; /* border-gray-600 */
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #1f2937; /* bg-gray-800 */
            max-width: 380px;
            margin: auto;
        }
        .nutrition-label h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 800;
            margin-bottom: 0.25rem;
        }
        .nutrition-label .serving-size {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .nutrition-label .header {
            border-bottom: 10px solid #4b5563; /* border-gray-600 */
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .nutrition-label .item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #374151; /* border-gray-700 */
        }
        .nutrition-label .item span:first-child {
            font-weight: 600;
        }
        .nutrition-label .item .indent {
            margin-left: 1.5rem;
        }
        .nutrition-label .footer {
            border-top: 5px solid #4b5563; /* border-gray-600 */
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        /* Accordion styles */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-50">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-semibold">Initializing Calverse...</p>
        </div>
    </div>

    <div id="auth-container" class="hidden h-screen w-screen flex items-center justify-center bg-gray-900">
        <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-sm mx-auto">
            <h1 class="text-4xl font-bold text-white mb-2">Welcome to Calverse</h1>
            <p class="text-gray-400 mb-8">Your AI-powered health companion.</p>
            <button id="google-signin-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition duration-300 ease-in-out">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691c-1.258 3.055-1.95 6.45-1.95 10.023s.692 6.968 1.95 10.023l-5.657 5.657C.252 34.668 0 29.556 0 24.614s.252-10.053 1.95-15.58l5.657 5.657z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657C30.01 35.091 27.215 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-5.657 5.657C9.033 40.519 15.903 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083L43.595 20L42 20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l5.657 5.657C42.463 35.931 44 30.556 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign In with Google
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar bg-gray-800 text-gray-200 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0">
                <a href="#" class="text-white flex items-center space-x-2 px-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"/><path d="M7 13l3 3 7-7"/></svg>
                    <span class="text-2xl font-extrabold">Calverse</span>
                </a>
                <nav id="main-nav">
                    <a href="#nutrition-lookup" class="nav-link block py-2.5 px-4 rounded transition duration-200 bg-gray-700 text-white">
                        <i data-lucide="search" class="inline-block w-5 h-5 mr-2"></i> Nutrition Lookup
                    </a>
                    <a href="#know-your-meal" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                        <i data-lucide="utensils-crossed" class="inline-block w-5 h-5 mr-2"></i> Know Your Meal
                    </a>
                    <a href="#recipe-suggestions" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                        <i data-lucide="notebook-pen" class="inline-block w-5 h-5 mr-2"></i> Recipes & Cravings
                    </a>
                    <a href="#health-calculators" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                        <i data-lucide="calculator" class="inline-block w-5 h-5 mr-2"></i> Health Calculators
                    </a>
                    <a href="#settings" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                        <i data-lucide="settings" class="inline-block w-5 h-5 mr-2"></i> Settings
                    </a>
                </nav>
            </aside>

            <!-- Main content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-gray-800/50 backdrop-blur-sm shadow-md sticky top-0 z-10">
                    <div class="flex justify-between items-center p-4">
                        <div class="flex items-center">
                            <button id="mobile-menu-btn" class="md:hidden text-gray-300 focus:outline-none mr-4">
                                <i data-lucide="menu" class="h-6 w-6"></i>
                            </button>
                            <h1 id="page-title" class="text-xl font-semibold">Nutrition Lookup</h1>
                        </div>
                        <button id="profile-avatar-btn" class="flex items-center space-x-2">
                            <img id="user-avatar" src="https://placehold.co/40x40/7c3aed/ffffff?text=U" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-indigo-400">
                        </button>
                    </div>
                </header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-4 sm:p-6 lg:p-8">
                    
                    <!-- App Sections -->
                    <section id="nutrition-lookup" class="app-section">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4">AI-Powered Nutrition Lookup</h2>
                            <p class="text-gray-400 mb-6">Enter a food item and quantity to get its detailed nutrition facts.</p>
                            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                                <input id="nutrition-input" type="text" placeholder="e.g., '100g soya chunks' or '2 medium bananas'" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                                <button id="get-nutrition-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center">
                                    <i data-lucide="bar-chart-big" class="w-5 h-5 mr-2"></i> Analyze
                                </button>
                            </div>
                            <div id="nutrition-output" class="mt-8">
                                <!-- FDA Label will be rendered here -->
                            </div>
                        </div>
                    </section>
                    
                    <section id="know-your-meal" class="app-section hidden">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4">Know Your Meal</h2>
                            <p class="text-gray-400 mb-6">Paste a recipe URL or list ingredients to analyze your entire meal.</p>
                            <div class="space-y-6">
                                <input id="meal-url-input" type="text" placeholder="Paste a recipe URL (e.g., from YouTube, blogs)" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                                <div class="text-center text-gray-500">OR</div>
                                <textarea id="meal-ingredients-input" placeholder="List ingredients and quantities, e.g.,&#10;1 cup cooked rice&#10;150g grilled chicken breast&#10;1/2 avocado" class="w-full h-32 bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></textarea>
                                <button id="analyze-meal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center">
                                    <i data-lucide="brain-circuit" class="w-5 h-5 mr-2"></i> Analyze Meal
                                </button>
                            </div>
                             <div id="meal-output" class="mt-8">
                                <!-- Meal analysis will be rendered here -->
                            </div>
                        </div>
                    </section>

                    <section id="recipe-suggestions" class="app-section hidden">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4">Recipes & Cravings</h2>
                            <p class="text-gray-400 mb-6">Get recipe ideas based on ingredients you have, or find healthier alternatives for your cravings.</p>
                            <div class="grid md:grid-cols-2 gap-8">
                                <!-- Recipe Generator -->
                                <div class="bg-gray-800 p-6 rounded-lg">
                                    <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-lucide="chef-hat" class="w-6 h-6 mr-2 text-indigo-400"></i>Recipe Generator</h3>
                                    <textarea id="recipe-ingredients-input" placeholder="What ingredients do you have?&#10;e.g., chicken breast, broccoli, soy sauce, garlic" class="w-full h-32 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></textarea>
                                    <button id="generate-recipe-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Generate Recipe</button>
                                </div>
                                <!-- Craving Solver -->
                                <div class="bg-gray-800 p-6 rounded-lg">
                                    <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-lucide="cookie" class="w-6 h-6 mr-2 text-indigo-400"></i>Craving Solver</h3>
                                    <input id="craving-input" type="text" placeholder="What are you craving? e.g., Pizza" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                                    <button id="solve-craving-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Find Healthy Alternative</button>
                                </div>
                            </div>
                            <div id="recipe-output" class="mt-8">
                                <!-- Recipe/Craving output will be rendered here -->
                            </div>
                        </div>
                    </section>

                    <section id="health-calculators" class="app-section hidden">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4">Health Calculators</h2>
                            <p class="text-gray-400 mb-6">A suite of tools to help you track your health metrics.</p>
                            <div id="calculator-accordion" class="space-y-4">
                                <!-- BMI Calculator -->
                                <div class="accordion-item bg-gray-800 rounded-lg">
                                    <button class="accordion-header w-full text-left p-4 font-semibold text-lg flex justify-between items-center">
                                        <span>BMI (Body Mass Index) Calculator</span>
                                        <i data-lucide="chevron-down" class="transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-4 pb-4">
                                        <div class="grid sm:grid-cols-2 gap-4">
                                            <input type="number" id="bmi-height" placeholder="Height (cm)" class="bg-gray-700 p-2 rounded">
                                            <input type="number" id="bmi-weight" placeholder="Weight (kg)" class="bg-gray-700 p-2 rounded">
                                        </div>
                                        <button onclick="calculateBMI()" class="mt-4 bg-indigo-600 px-4 py-2 rounded">Calculate</button>
                                        <p id="bmi-result" class="mt-4 font-bold"></p>
                                    </div>
                                </div>
                                <!-- BMR Calculator -->
                                <div class="accordion-item bg-gray-800 rounded-lg">
                                    <button class="accordion-header w-full text-left p-4 font-semibold text-lg flex justify-between items-center">
                                        <span>BMR (Basal Metabolic Rate) Calculator</span>
                                        <i data-lucide="chevron-down" class="transform transition-transform"></i>
                                    </button>
                                    <div class="accordion-content px-4 pb-4">
                                        <div class="grid sm:grid-cols-2 gap-4">
                                            <input type="number" id="bmr-age" placeholder="Age" class="bg-gray-700 p-2 rounded">
                                            <select id="bmr-gender" class="bg-gray-700 p-2 rounded">
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                            <input type="number" id="bmr-height" placeholder="Height (cm)" class="bg-gray-700 p-2 rounded">
                                            <input type="number" id="bmr-weight" placeholder="Weight (kg)" class="bg-gray-700 p-2 rounded">
                                        </div>
                                        <button onclick="calculateBMR()" class="mt-4 bg-indigo-600 px-4 py-2 rounded">Calculate</button>
                                        <p id="bmr-result" class="mt-4 font-bold"></p>
                                    </div>
                                </div>
                                <!-- Other calculators can be added here -->
                            </div>
                        </div>
                    </section>

                    <section id="settings" class="app-section hidden">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-4">Settings</h2>
                            <div class="bg-gray-800 p-6 rounded-lg">
                                <h3 class="text-xl font-semibold mb-2" id="user-name-display">User Name</h3>
                                <p class="text-gray-400 mb-4" id="user-email-display">user@example.com</p>
                                <p class="text-gray-400 text-sm" id="user-id-display">User ID: </p>
                            </div>
                             <footer class="text-center mt-12 text-gray-500">
                                Made with ❤️ by Ashutosh Roy
                            </footer>
                        </div>
                    </section>
                </main>
            </div>
        </div>

        <!-- Profile Drawer -->
        <div id="profile-drawer" class="profile-drawer fixed bottom-0 right-0 h-screen w-80 bg-gray-800 shadow-lg p-6 transform translate-x-full z-30">
            <button id="close-drawer-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="flex flex-col items-center">
                <img id="drawer-user-avatar" src="https://placehold.co/80x80/7c3aed/ffffff?text=U" alt="User Avatar" class="w-20 h-20 rounded-full border-4 border-indigo-400 mb-4">
                <h3 id="drawer-user-name" class="text-xl font-semibold">User Name</h3>
                <p id="drawer-user-email" class="text-sm text-gray-400">user@example.com</p>
                <button id="logout-btn" class="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Logout
                </button>
            </div>
        </div>
        <div id="drawer-overlay" class="fixed inset-0 bg-black/50 z-20 hidden"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCu5RfnRhT9refiyybPcW_IBt_7l5cgt2I",
  authDomain: "calverse-e3cdb.firebaseapp.com",
  projectId: "calverse-e3cdb",
  storageBucket: "calverse-e3cdb.firebasestorage.app",
  messagingSenderId: "284415302963",
  appId: "1:284415302963:web:936ad62e589bad6fc9b246",
  measurementId: "G-X28DSX7WYB"
};
      
        
        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Firestore persistence failed: Multiple tabs open?");
            } else if (err.code == 'unimplemented') {
                console.warn("Firestore persistence not available in this browser.");
            }
        });

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();

        googleSignInBtn.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                await handleUserLogin(user);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.reload();
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                handleUserLogin(user);
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                // Initialize icons once the app container is visible
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } else {
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                loadingOverlay.classList.add('hidden');
            }
        });

        async function handleUserLogin(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
                const simpleName = user.displayName.split(' ')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
                const customId = `${simpleName}-${randomPart}`;

                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    customId: customId,
                    createdAt: new Date()
                });
            }
            updateUIWithUserData(user);
        }

        async function updateUIWithUserData(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            const userData = userDoc.data();

            // Nav Bar
            document.getElementById('user-avatar').src = user.photoURL || `https://placehold.co/40x40/7c3aed/ffffff?text=${user.displayName[0]}`;
            // Profile Drawer
            document.getElementById('drawer-user-avatar').src = user.photoURL || `https://placehold.co/80x80/7c3aed/ffffff?text=${user.displayName[0]}`;
            document.getElementById('drawer-user-name').textContent = user.displayName;
            document.getElementById('drawer-user-email').textContent = user.email;
            // Settings Page
            document.getElementById('user-name-display').textContent = user.displayName;
            document.getElementById('user-email-display').textContent = user.email;
            document.getElementById('user-id-display').textContent = `User ID: ${userData.customId}`;
        }

        // --- GEMINI API LOGIC ---
        const geminiKeys = [ "AIzaSyAjKByev9K4Zh6Tx9b99ESdBYT-7iEp850","AIzaSyAIJZmqyztvwoThqI7iu2-xzQr71aJaKEU" ];
        let currentKeyIndex = 0;

        const nutritionSchema = {
            type: "OBJECT",
            properties: {
                foodItem: { type: "STRING" },
                servingSize: { type: "STRING" },
                calories: { type: "NUMBER" },
                totalFat: { type: "STRING" },
                saturatedFat: { type: "STRING" },
                transFat: { type: "STRING" },
                cholesterol: { type: "STRING" },
                sodium: { type: "STRING" },
                totalCarbohydrate: { type: "STRING" },
                dietaryFiber: { type: "STRING" },
                totalSugars: { type: "STRING" },
                protein: { type: "STRING" },
                vitaminD: { type: "STRING" },
                calcium: { type: "STRING" },
                iron: { type: "STRING" },
                potassium: { type: "STRING" },
            },
            required: ["foodItem", "servingSize", "calories", "totalFat", "protein", "totalCarbohydrate"]
        };

        async function callGeminiApi(prompt, schema = null) {
            if (geminiKeys.length === 0) {
                console.error("Gemini API keys are not configured.");
                alert("This feature is currently unavailable. API keys are not set up.");
                return null;
            }

            const apiKey = geminiKeys[currentKeyIndex];
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: schema ? {
                    responseMimeType: "application/json",
                    responseSchema: schema
                } : {}
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    const content = data.candidates[0].content.parts[0].text;
                    return schema ? JSON.parse(content) : content;
                } else {
                     throw new Error("No content returned from API.");
                }

            } catch (error) {
                console.error(`Error with API key index ${currentKeyIndex}:`, error);
                currentKeyIndex = (currentKeyIndex + 1) % geminiKeys.length;
                console.log(`Failing over to next API key index: ${currentKeyIndex}`);
                // Simple failover, doesn't retry the same request automatically in this version
                alert("An error occurred while contacting the AI. Please try again.");
                return null;
            }
        }

        // --- UI & NAVIGATION ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.app-section');
        const pageTitle = document.getElementById('page-title');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                
                // Update active link style
                navLinks.forEach(l => l.classList.remove('bg-gray-700', 'text-white'));
                link.classList.add('bg-gray-700', 'text-white');

                // Show target section
                sections.forEach(section => {
                    if (section.id === targetId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });

                // Update page title
                pageTitle.textContent = link.textContent.trim();
                
                // Close sidebar on mobile after navigation
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            });
        });

        // Mobile menu toggle
        const sidebar = document.getElementById('sidebar');
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        // Profile drawer toggle
        const profileDrawer = document.getElementById('profile-drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        document.getElementById('profile-avatar-btn').addEventListener('click', () => {
            profileDrawer.classList.remove('translate-x-full');
            drawerOverlay.classList.remove('hidden');
        });
        document.getElementById('close-drawer-btn').addEventListener('click', () => {
            profileDrawer.classList.add('translate-x-full');
            drawerOverlay.classList.add('hidden');
        });
        drawerOverlay.addEventListener('click', () => {
            profileDrawer.classList.add('translate-x-full');
            drawerOverlay.classList.add('hidden');
        });

        // Accordion logic for calculators
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('i');
                
                header.parentElement.parentElement.querySelectorAll('.accordion-content').forEach(c => {
                    if (c !== content) {
                        c.style.maxHeight = null;
                        c.previousElementSibling.querySelector('i').classList.remove('rotate-180');
                    }
                });

                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    icon.classList.remove('rotate-180');
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.classList.add('rotate-180');
                }
            });
        });

        // --- FEATURE LOGIC ---
        
        // Nutrition Lookup
        const getNutritionBtn = document.getElementById('get-nutrition-btn');
        const nutritionInput = document.getElementById('nutrition-input');
        const nutritionOutput = document.getElementById('nutrition-output');

        getNutritionBtn.addEventListener('click', handleGetNutrition);
        nutritionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleGetNutrition();
        });

        async function handleGetNutrition() {
            const query = nutritionInput.value.trim();
            if (!query) return;

            setLoadingState(getNutritionBtn, true, 'Analyzing...');
            nutritionOutput.innerHTML = getSpinnerHTML('Fetching nutrition data...');

            const prompt = `Analyze the nutrition facts for the following food item and provide the data in JSON format according to the specified schema. All values should be strings, except for calories which should be a number. If a value is not applicable or unknown, use "N/A". Food: "${query}"`;
            
            const data = await callGeminiApi(prompt, nutritionSchema);
            
            if (data) {
                nutritionOutput.innerHTML = renderNutritionLabel(data);
            } else {
                nutritionOutput.innerHTML = `<p class="text-red-400">Could not retrieve nutrition data. Please try again.</p>`;
            }
            setLoadingState(getNutritionBtn, false, 'Analyze');
        }

        // Know Your Meal
        const analyzeMealBtn = document.getElementById('analyze-meal-btn');
        const mealUrlInput = document.getElementById('meal-url-input');
        const mealIngredientsInput = document.getElementById('meal-ingredients-input');
        const mealOutput = document.getElementById('meal-output');

        analyzeMealBtn.addEventListener('click', async () => {
            const url = mealUrlInput.value.trim();
            const ingredients = mealIngredientsInput.value.trim();
            if (!url && !ingredients) return;

            setLoadingState(analyzeMealBtn, true, 'Analyzing...');
            mealOutput.innerHTML = getSpinnerHTML('Analyzing your meal...');

            const mealInput = url ? `URL: ${url}` : `Ingredients: ${ingredients}`;
            const prompt = `Analyze the following meal. First, provide the total nutrition facts for the entire meal in the specified JSON schema format. Second, provide two actionable suggestions: one to improve the taste and one to improve the healthiness of the meal. Format the suggestions as a simple string. Meal details: ${mealInput}`;
            
            // For this combined prompt, we will parse the response manually
            const responseText = await callGeminiApi(prompt);

            if (responseText) {
                try {
                    // This is a simplified parsing. A more robust solution might need more advanced logic.
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    const suggestionsMatch = responseText.split(/\{[\s\S]*\}/)[1];

                    const nutritionData = JSON.parse(jsonMatch[0]);
                    
                    let html = renderNutritionLabel(nutritionData, 'Total Meal Nutrition');
                    html += `<div class="mt-8 bg-gray-800 p-6 rounded-lg">
                                <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-lucide="lightbulb" class="w-6 h-6 mr-2 text-yellow-400"></i>AI Suggestions</h3>
                                <div class="text-gray-300">${suggestionsMatch.replace(/\n/g, '<br>')}</div>
                             </div>`;
                    mealOutput.innerHTML = html;
                    lucide.createIcons();
                } catch (e) {
                    console.error("Error parsing meal response:", e);
                    mealOutput.innerHTML = `<p class="text-red-400">Could not parse the meal analysis. The AI returned an unexpected format.</p>`;
                }
            } else {
                mealOutput.innerHTML = `<p class="text-red-400">Could not analyze the meal. Please try again.</p>`;
            }
            setLoadingState(analyzeMealBtn, false, 'Analyze Meal');
        });

        // Recipe & Cravings
        const generateRecipeBtn = document.getElementById('generate-recipe-btn');
        const solveCravingBtn = document.getElementById('solve-craving-btn');
        const recipeOutput = document.getElementById('recipe-output');

        generateRecipeBtn.addEventListener('click', async () => {
            const ingredients = document.getElementById('recipe-ingredients-input').value.trim();
            if (!ingredients) return;
            setLoadingState(generateRecipeBtn, true, 'Generating...');
            recipeOutput.innerHTML = getSpinnerHTML('Creating a recipe for you...');
            const prompt = `Create a healthy and delicious recipe using the following ingredients: ${ingredients}. Provide a recipe name, a list of ingredients (including the ones provided), and step-by-step instructions. Format the response clearly with headings.`;
            const recipe = await callGeminiApi(prompt);
            if (recipe) {
                recipeOutput.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg">${recipe.replace(/\n/g, '<br>')}</div>`;
            } else {
                 recipeOutput.innerHTML = `<p class="text-red-400">Could not generate a recipe. Please try again.</p>`;
            }
            setLoadingState(generateRecipeBtn, false, 'Generate Recipe');
        });

        solveCravingBtn.addEventListener('click', async () => {
            const craving = document.getElementById('craving-input').value.trim();
            if (!craving) return;
            setLoadingState(solveCravingBtn, true, 'Solving...');
            recipeOutput.innerHTML = getSpinnerHTML('Finding a healthy alternative...');
            const prompt = `I'm craving ${craving}. Suggest a delicious and healthy alternative recipe. Provide the recipe name, ingredients, and step-by-step instructions. Explain briefly why it's a healthier choice.`;
            const alternative = await callGeminiApi(prompt);
            if (alternative) {
                recipeOutput.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg">${alternative.replace(/\n/g, '<br>')}</div>`;
            } else {
                 recipeOutput.innerHTML = `<p class="text-red-400">Could not find an alternative. Please try again.</p>`;
            }
            setLoadingState(solveCravingBtn, false, 'Find Healthy Alternative');
        });


        // --- HELPER FUNCTIONS ---
        function renderNutritionLabel(data, title = 'Nutrition Facts') {
            return `
                <div class="nutrition-label">
                    <div class="header">
                        <h1>${title}</h1>
                        <div class="serving-size">${data.foodItem || 'N/A'}</div>
                        <div>Serving Size ${data.servingSize || 'N/A'}</div>
                    </div>
                    <div class="item"><span>Calories</span> <span>${data.calories || 'N/A'}</span></div>
                    <div class="item"><span>Total Fat</span> <span>${data.totalFat || 'N/A'}</span></div>
                    <div class="item indent"><span>Saturated Fat</span> <span>${data.saturatedFat || 'N/A'}</span></div>
                    <div class="item indent"><span>Trans Fat</span> <span>${data.transFat || 'N/A'}</span></div>
                    <div class="item"><span>Cholesterol</span> <span>${data.cholesterol || 'N/A'}</span></div>
                    <div class="item"><span>Sodium</span> <span>${data.sodium || 'N/A'}</span></div>
                    <div class="item"><span>Total Carbohydrate</span> <span>${data.totalCarbohydrate || 'N/A'}</span></div>
                    <div class="item indent"><span>Dietary Fiber</span> <span>${data.dietaryFiber || 'N/A'}</span></div>
                    <div class="item indent"><span>Total Sugars</span> <span>${data.totalSugars || 'N/A'}</span></div>
                    <div class="item"><span>Protein</span> <span>${data.protein || 'N/A'}</span></div>
                    <div class="footer">
                        <div class="item"><span>Vitamin D</span> <span>${data.vitaminD || 'N/A'}</span></div>
                        <div class="item"><span>Calcium</span> <span>${data.calcium || 'N/A'}</span></div>
                        <div class="item"><span>Iron</span> <span>${data.iron || 'N/A'}</span></div>
                        <div class="item"><span>Potassium</span> <span>${data.potassium || 'N/A'}</span></div>
                    </div>
                </div>
            `;
        }
        
        function setLoadingState(button, isLoading, loadingText) {
            const originalContent = button.innerHTML;
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ${loadingText}
                `;
            } else {
                button.disabled = false;
                // The button's original content needs to be restored correctly.
                // The loadingText parameter when isLoading is false will be the original text.
                button.innerHTML = loadingText;
            }
        }

        function getSpinnerHTML(text) {
            return `
                <div class="flex flex-col items-center justify-center p-8 text-center">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-lg font-semibold text-gray-300">${text}</p>
                </div>
            `;
        }

        // --- CALCULATOR FUNCTIONS (Global Scope) ---
        window.calculateBMI = function() {
            const height = parseFloat(document.getElementById('bmi-height').value);
            const weight = parseFloat(document.getElementById('bmi-weight').value);
            const resultEl = document.getElementById('bmi-result');
            if (height > 0 && weight > 0) {
                const bmi = (weight / ((height / 100) ** 2)).toFixed(2);
                let category = '';
                if (bmi < 18.5) category = 'Underweight';
                else if (bmi < 24.9) category = 'Normal weight';
                else if (bmi < 29.9) category = 'Overweight';
                else category = 'Obesity';
                resultEl.textContent = `Your BMI is ${bmi} (${category})`;
            } else {
                resultEl.textContent = 'Please enter valid height and weight.';
            }
        }

        window.calculateBMR = function() {
            const age = parseFloat(document.getElementById('bmr-age').value);
            const gender = document.getElementById('bmr-gender').value;
            const height = parseFloat(document.getElementById('bmr-height').value);
            const weight = parseFloat(document.getElementById('bmr-weight').value);
            const resultEl = document.getElementById('bmr-result');

            if (age > 0 && height > 0 && weight > 0) {
                let bmr = 0;
                if (gender === 'male') {
                    bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                } else {
                    bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                }
                resultEl.textContent = `Your BMR is approx. ${bmr.toFixed(0)} calories/day.`;
            } else {
                resultEl.textContent = 'Please fill in all fields correctly.';
            }
        }

    </script>
</body>
</html>
