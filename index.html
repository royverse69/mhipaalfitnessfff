<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calverse</title>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- Professional UI Overhaul --- */
        :root {
            --primary-color: #f59e0b; /* A richer, modern orange/yellow */
            --background-color: #f4f4f5; /* Light gray */
            --surface-color: #ffffff;
            --text-color: #18181b;
            --text-muted-color: #71717a;
            --border-color: #e4e4e7;
            --error-color: #ef4444;
            --success-color: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding-top: 80px; /* Header height + padding */
        }

        /* --- Header --- */
        header {
            background-color: var(--surface-color);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .logo .material-icons {
            font-size: 2rem;
            margin-right: 0.5rem;
        }

        .profile-container {
            position: relative;
        }

        #user-profile-icon {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--border-color);
            overflow: hidden;
        }
        
        #user-profile-icon .material-icons {
            font-size: 2rem;
            color: var(--text-muted-color);
        }
        
        #user-profile-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #profile-menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 0;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 180px;
            z-index: 101;
            overflow: hidden;
        }

        #profile-menu button {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
        }

        #profile-menu button:hover {
            background-color: var(--background-color);
        }
        
        #logout-btn {
            color: var(--error-color);
        }

        /* --- Main Content & Accordion Structure --- */
        main {
            padding: 0 1rem 80px 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .accordion-item {
            background-color: var(--surface-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            cursor: pointer;
        }
        
        .accordion-header h2 {
            font-size: 1.25rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .accordion-header .icon {
            transition: transform 0.3s ease;
        }
        
        .accordion-item.active .accordion-header .icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        
        .accordion-content-inner {
            padding: 0 1.25rem 1.25rem 1.25rem;
            border-top: 1px solid var(--border-color);
        }

        /* --- Forms & Inputs --- */
        .input-group {
            margin-bottom: 1.5rem;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-muted-color);
            font-size: 0.9rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        button {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 14px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
        }
        
        button:active {
            transform: scale(0.98);
        }

        /* --- Results & Utility --- */
        .results-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--background-color);
            border-radius: 8px;
            min-height: 50px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .disclaimer {
            font-size: 0.8rem;
            color: var(--text-muted-color);
            background-color: var(--background-color);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }

        /* --- Calculator Specific --- */
        #calculators-accordion .accordion-item {
            background-color: var(--background-color);
            border: none;
        }
        
        #calculators-accordion .accordion-header {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--surface-color);
        }
        
        #calculators-accordion .accordion-content-inner {
            padding: 1.25rem;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            margin-top: -8px;
            background-color: var(--surface-color);
        }
        
        .calc-input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .calc-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: center;
            gap: 1rem;
        }

        /* --- Login Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 400px;
            border-radius: 16px;
            text-align: center;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #login-with-google-btn {
            background-color: #4285F4;
            color: #fff;
            width: 100%;
            margin-top: 1.5rem;
        }
        #login-with-google-btn img {
            width: 20px;
            height: 20px;
            background-color: #fff;
            border-radius: 50%;
            padding: 2px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo">
            <span class="material-icons">spa</span>
            <span>Calverse</span>
        </div>
        <div class="profile-container">
            <div id="user-profile-icon">
                <span class="material-icons">account_circle</span>
            </div>
            <div id="profile-menu">
                <button id="logout-btn"><span class="material-icons">logout</span>Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-accordion">
        <!-- Section 1: Nutrition Search -->
        <div class="accordion-item">
            <div class="accordion-header" data-target="nutrition-content">
                <h2><span class="material-icons">search</span>Nutrition Lookup</h2>
                <span class="material-icons icon">expand_more</span>
            </div>
            <div class="accordion-content" id="nutrition-content">
                <div class="accordion-content-inner">
                    <div class="input-group">
                        <label for="food-search-input">Enter a food item with its quantity.</label>
                        <input type="text" id="food-search-input" placeholder="e.g., 100g of soya chunks">
                    </div>
                    <button id="food-search-btn">Get Nutrition Facts</button>
                    <div id="nutrition-results" class="results-container"></div>
                </div>
            </div>
        </div>

        <!-- Section 2: Know Your Meal -->
        <div class="accordion-item">
            <div class="accordion-header" data-target="meal-content">
                <h2><span class="material-icons">restaurant_menu</span>Know Your Meal</h2>
                <span class="material-icons icon">expand_more</span>
            </div>
            <div class="accordion-content" id="meal-content">
                <div class="accordion-content-inner">
                    <div class="input-group">
                        <label for="meal-ingredients-input">List Ingredients (one per line)</label>
                        <textarea id="meal-ingredients-input" placeholder="e.g.,&#10;1 cup rice&#10;150g lentils&#10;1 tbsp olive oil"></textarea>
                        <button id="analyze-meal-btn">Analyze Ingredients</button>
                    </div>
                    <div id="meal-results" class="results-container"></div>
                </div>
            </div>
        </div>
        
        <!-- Section 3: Recipe Suggestions -->
        <div class="accordion-item">
            <div class="accordion-header" data-target="recipe-content">
                <h2><span class="material-icons">menu_book</span>Recipe Ideas</h2>
                <span class="material-icons icon">expand_more</span>
            </div>
            <div class="accordion-content" id="recipe-content">
                <div class="accordion-content-inner">
                    <div class="input-group">
                        <label for="recipe-ingredients-input">What ingredients do you have?</label>
                        <textarea id="recipe-ingredients-input" placeholder="e.g., chicken, tomatoes, onions, garlic"></textarea>
                        <button id="get-recipe-btn">Suggest a Recipe</button>
                    </div>
                    <div class="input-group">
                        <label for="craving-input">What are you craving?</label>
                        <input type="text" id="craving-input" placeholder="e.g., something sweet and chocolaty">
                        <button id="get-craving-btn">Find Healthier Alternative</button>
                    </div>
                    <div id="recipe-results" class="results-container"></div>
                </div>
            </div>
        </div>

        <!-- Section 4: Calculators -->
        <div class="accordion-item">
            <div class="accordion-header" data-target="calculators-content">
                <h2><span class="material-icons">calculate</span>Health Calculators</h2>
                <span class="material-icons icon">expand_more</span>
            </div>
            <div class="accordion-content" id="calculators-content">
                <div class="accordion-content-inner" id="calculators-accordion">
                    <!-- Calculator accordions will be injected here -->
                </div>
            </div>
        </div>
    </main>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Welcome to Calverse</h3>
            <p>Sign in with Google to save your data and track your nutrition journey.</p>
            <div id="login-error-message" class="error-message" style="display: none; margin-bottom: 1rem; margin-top: 1rem; background-color: #B00020; color: #fff;"></div>
            <button id="login-with-google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- API & Firebase Configuration ---
        const GEMINI_API_KEYS = [
            "AIzaSyCiPL-DcZN82CxH6OmYv9Ll4yM3WiVjxXY",
            "AIzaSyAvU63lMyAjbSJfcTBuBnkZQ0DPoBpm6Ho",
            "AIzaSyAIJZmqyztvwoThqI7iu2-xzQr71aJaKEU",
            "AIzaSyAmbO3Szmr9vAj24MkRkbMQeQi1j7_-m4Y"
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyCu5RfnRhT9refiyybPcW_IBt_7l5cgt2I",
            authDomain: "calverse-e3cdb.firebaseapp.com",
            projectId: "calverse-e3cdb",
            storageBucket: "calverse-e3cdb.firebasestorage.app",
            messagingSenderId: "284415302963",
            appId: "1:284415302963:web:936ad62e589bad6fc9b246",
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let userId = null;

        // --- Gemini API Key Management ---
        let currentApiKeyIndex = 0;

        async function geminiFetch(prompt, resultContainer) {
            showLoader(resultContainer);
            for (let i = 0; i < GEMINI_API_KEYS.length; i++) {
                const apiKey = GEMINI_API_KEYS[currentApiKeyIndex];
                // CRITICAL FIX: Using the correct v1 endpoint and a valid model name
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(`API Error (${response.status}): ${errorData.error.message}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates.length > 0) {
                        hideLoader(resultContainer);
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API.");
                    }

                } catch (error) {
                    console.warn(`API Key ${currentApiKeyIndex + 1} failed: ${error.message}. Trying next one.`);
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % GEMINI_API_KEYS.length;
                }
            }
            
            hideLoader(resultContainer);
            showError("All API attempts failed. The service might be temporarily unavailable. Please try again later.", resultContainer);
            return null;
        }

        // --- UI Element Selectors ---
        const loginModal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-with-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileIcon = document.getElementById('user-profile-icon');
        const profileMenu = document.getElementById('profile-menu');

        // --- Authentication Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                userId = generateUserId(user.displayName);
                loginModal.style.display = 'none';
                updateProfileIcon(user.photoURL);
            } else {
                currentUser = null;
                userId = null;
                loginModal.style.display = 'flex';
                updateProfileIcon(null);
            }
        });

        loginBtn.addEventListener('click', () => {
            const errorMessageDiv = document.getElementById('login-error-message');
            errorMessageDiv.style.display = 'none';
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                let message = "An unknown error occurred. Please try again.";
                if (error.code === 'auth/popup-blocked') {
                    message = "Login popup blocked by your browser. Please allow popups for this site.";
                }
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
            });
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            profileMenu.style.display = 'none';
        });

        profileIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentUser) {
                profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
            } else {
                loginModal.style.display = 'flex';
            }
        });
        
        window.addEventListener('click', () => profileMenu.style.display = 'none');


        function generateUserId(name) {
            const namePart = name ? name.slice(0, 3).toLowerCase() : 'usr';
            const randomPart = Math.random().toString(36).substring(2, 7);
            return `${namePart}${randomPart}`;
        }
        
        function updateProfileIcon(photoURL) {
            if (photoURL) {
                profileIcon.innerHTML = `<img src="${photoURL}" alt="Profile Picture">`;
            } else {
                profileIcon.innerHTML = `<span class="material-icons">account_circle</span>`;
            }
        }
        
        // --- Accordion Logic ---
        function setupAccordion(containerId) {
            const accordionContainer = document.getElementById(containerId);
            accordionContainer.addEventListener('click', function(e) {
                const header = e.target.closest('.accordion-header');
                if (!header) return;
                
                const item = header.parentElement;
                const content = document.getElementById(header.dataset.target);
                const isActive = item.classList.contains('active');

                // Optional: Close other items when one is opened
                // this.querySelectorAll('.accordion-item').forEach(otherItem => {
                //     otherItem.classList.remove('active');
                //     otherItem.querySelector('.accordion-content').style.maxHeight = '0px';
                // });

                if (!isActive) {
                    item.classList.add('active');
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    item.classList.remove('active');
                    content.style.maxHeight = '0px';
                }
            });
        }
        setupAccordion('main-accordion');
        setupAccordion('calculators-accordion');


        // --- Section 1: Nutrition Lookup ---
        document.getElementById('food-search-btn').addEventListener('click', async () => {
            const query = document.getElementById('food-search-input').value.trim();
            const resultsContainer = document.getElementById('nutrition-results');
            if (!query) return;
            const prompt = `Provide a detailed nutrition facts label for "${query}". The output should be plain text, formatted like a standard US nutrition label. Include values for Calories, Total Fat, Saturated Fat, Trans Fat, Cholesterol, Sodium, Total Carbohydrate, Dietary Fiber, Total Sugars, and Protein. Also include values for Vitamin D, Calcium, Iron, and Potassium.`;
            const result = await geminiFetch(prompt, resultsContainer);
            if (result) resultsContainer.textContent = result;
        });

        // --- Section 2: Know Your Meal ---
        document.getElementById('analyze-meal-btn').addEventListener('click', async () => {
            const ingredients = document.getElementById('meal-ingredients-input').value.trim();
            const resultsContainer = document.getElementById('meal-results');
            if (!ingredients) return;
            const prompt = `Analyze the nutritional content of a meal with these ingredients:\n${ingredients}\n\nFirst, provide an estimated total for key nutrients (Calories, Protein, Carbs, Fat). Then, give two specific, actionable suggestions to make this meal healthier and tastier. Format the entire response clearly with headings.`;
            const result = await geminiFetch(prompt, resultsContainer);
            if (result) resultsContainer.textContent = result;
        });

        // --- Section 3: Recipe Suggestions ---
        document.getElementById('get-recipe-btn').addEventListener('click', async () => {
            const ingredients = document.getElementById('recipe-ingredients-input').value.trim();
            const resultsContainer = document.getElementById('recipe-results');
            if (!ingredients) return;
            const prompt = `I have the following ingredients: ${ingredients}. Suggest a healthy and delicious recipe I can make. Provide a name for the recipe, a list of required ingredients, and a step-by-step cooking process.`;
            const result = await geminiFetch(prompt, resultsContainer);
            if (result) resultsContainer.textContent = result;
        });
        
        document.getElementById('get-craving-btn').addEventListener('click', async () => {
            const craving = document.getElementById('craving-input').value.trim();
            const resultsContainer = document.getElementById('recipe-results');
            if (!craving) return;
            const prompt = `I'm craving "${craving}". Suggest a healthier, delicious alternative. Provide a recipe name, ingredients, and step-by-step instructions to make it.`;
            const result = await geminiFetch(prompt, resultsContainer);
            if (result) resultsContainer.textContent = result;
        });

        // --- Section 4: ALL Calculators ---
        const calculatorsContainer = document.getElementById('calculators-accordion');
        const calculatorTemplates = {
            bmi: { title: 'BMI Calculator', icon: 'monitor_weight', html: `
                <div class="calc-input-group">
                    <div class="calc-input-row"><label for="bmi-weight">Weight (kg)</label><input type="number" id="bmi-weight" placeholder="70"></div>
                    <div class="calc-input-row"><label for="bmi-height">Height (cm)</label><input type="number" id="bmi-height" placeholder="175"></div>
                </div><button onclick="calculateBMI()">Calculate BMI</button>`},
            bmr: { title: 'BMR Calculator', icon: 'local_fire_department', html: `
                <div class="calc-input-group">
                    <div class="calc-input-row"><label for="bmr-weight">Weight (kg)</label><input type="number" id="bmr-weight" placeholder="70"></div>
                    <div class="calc-input-row"><label for="bmr-height">Height (cm)</label><input type="number" id="bmr-height" placeholder="175"></div>
                    <div class="calc-input-row"><label for="bmr-age">Age</label><input type="number" id="bmr-age" placeholder="30"></div>
                    <div class="calc-input-row"><label for="bmr-gender">Gender</label><select id="bmr-gender"><option value="male">Male</option><option value="female">Female</option></select></div>
                </div><button onclick="calculateBMR()">Calculate BMR</button>`},
            bodyFat: { title: 'Body Fat Calculator', icon: 'fitness_center', html: `
                <p class="disclaimer" style="margin-bottom: 1rem; margin-top: 0;">Uses the U.S. Navy method. Measurements can be in cm or inches, just be consistent.</p>
                <div class="calc-input-group">
                    <div class="calc-input-row"><label for="bf-height">Height</label><input type="number" id="bf-height" placeholder="175"></div>
                    <div class="calc-input-row"><label for="bf-neck">Neck</label><input type="number" id="bf-neck" placeholder="38"></div>
                    <div class="calc-input-row"><label for="bf-waist">Waist</label><input type="number" id="bf-waist" placeholder="85"></div>
                    <div class="calc-input-row" id="bf-hip-row" style="display:none;"><label for="bf-hip">Hip</label><input type="number" id="bf-hip" placeholder="95"></div>
                    <div class="calc-input-row"><label for="bf-gender">Gender</label><select id="bf-gender" onchange="toggleHipInput(this.value)"><option value="male">Male</option><option value="female">Female</option></select></div>
                </div><button onclick="calculateBodyFat()">Calculate Body Fat %</button>`},
            idealWeight: { title: 'Ideal Weight Calculator', icon: 'scale', html: `
                <div class="calc-input-group">
                    <div class="calc-input-row"><label for="iw-height">Height (cm)</label><input type="number" id="iw-height" placeholder="175"></div>
                    <div class="calc-input-row"><label for="iw-gender">Gender</label><select id="iw-gender"><option value="male">Male</option><option value="female">Female</option></select></div>
                </div><button onclick="calculateIdealWeight()">Calculate Ideal Weight</button>`},
            lbm: { title: 'Lean Body Mass Calculator', icon: 'directions_run', html: `
                <div class="calc-input-group">
                    <div class="calc-input-row"><label for="lbm-weight">Weight (kg)</label><input type="number" id="lbm-weight" placeholder="70"></div>
                    <div class="calc-input-row"><label for="lbm-height">Height (cm)</label><input type="number" id="lbm-height" placeholder="175"></div>
                    <div class="calc-input-row"><label for="lbm-gender">Gender</label><select id="lbm-gender"><option value="male">Male</option><option value="female">Female</option></select></div>
                </div><button onclick="calculateLBM()">Calculate Lean Body Mass</button>`},
            ovulation: { title: 'Ovulation Calculator', icon: 'calendar_month', html: `
                <div class="calc-input-group">
                    <div class="calc-input-row"><label for="ov-last-period">First Day of Last Period</label><input type="date" id="ov-last-period"></div>
                    <div class="calc-input-row"><label for="ov-cycle-length">Average Cycle Length (days)</label><input type="number" id="ov-cycle-length" placeholder="28"></div>
                </div><button onclick="calculateOvulation()">Estimate Fertile Window</button>`},
        };

        function renderCalculators() {
            let html = '';
            for (const key in calculatorTemplates) {
                const calc = calculatorTemplates[key];
                html += `
                <div class="accordion-item" id="${key}-item">
                    <div class="accordion-header" data-target="${key}-content">
                        <h2><span class="material-icons">${calc.icon}</span>${calc.title}</h2>
                        <span class="material-icons icon">expand_more</span>
                    </div>
                    <div class="accordion-content" id="${key}-content">
                        <div class="accordion-content-inner">
                            ${calc.html}
                            <div id="${key}-results" class="results-container" style="display:none;"></div>
                            <div class="disclaimer">This calculator provides an estimate for informational purposes only and is not a substitute for professional medical advice.</div>
                        </div>
                    </div>
                </div>`;
            }
            calculatorsContainer.innerHTML = html;
        }
        renderCalculators();

        // --- Helper Functions for UI ---
        function showLoader(container) { container.innerHTML = '<div class="loader"></div>'; }
        function hideLoader(container) { if (container.querySelector('.loader')) container.innerHTML = ''; }
        function showError(message, container) { container.innerHTML = `<div class="error-message">${message}</div>`; }
        function showResult(id, content) {
            const el = document.getElementById(id);
            el.innerHTML = content;
            el.style.display = 'block';
        }

        // --- Make Calculation Functions Global for onclick ---
        window.calculateBMI = () => {
            const weight = parseFloat(document.getElementById('bmi-weight').value);
            const height = parseFloat(document.getElementById('bmi-height').value);
            if (!weight || !height) return;
            const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            let category = bmi < 18.5 ? 'Underweight' : bmi < 25 ? 'Normal weight' : bmi < 30 ? 'Overweight' : 'Obesity';
            showResult('bmi-results', `<h4>Your BMI is ${bmi}</h4><p>Category: ${category}</p>`);
        };
        
        window.calculateBMR = () => {
            const w = parseFloat(document.getElementById('bmr-weight').value), h = parseFloat(document.getElementById('bmr-height').value), age = parseInt(document.getElementById('bmr-age').value), gender = document.getElementById('bmr-gender').value;
            if (!w || !h || !age) return;
            let bmr = gender === 'male' ? (10 * w) + (6.25 * h) - (5 * age) + 5 : (10 * w) + (6.25 * h) - (5 * age) - 161;
            showResult('bmr-results', `<h4>Your BMR is ${bmr.toFixed(0)} kcal/day</h4><p>This is your estimated calories at rest.</p>`);
        };
        
        window.toggleHipInput = (gender) => { document.getElementById('bf-hip-row').style.display = gender === 'female' ? 'flex' : 'none'; };
        
        window.calculateBodyFat = () => {
            const h = parseFloat(document.getElementById('bf-height').value), neck = parseFloat(document.getElementById('bf-neck').value), waist = parseFloat(document.getElementById('bf-waist').value), gender = document.getElementById('bf-gender').value;
            const hip = parseFloat(document.getElementById('bf-hip').value);
            if (!h || !neck || !waist || (gender === 'female' && !hip)) return;
            let bfp = 0;
            if (gender === 'male') {
                bfp = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.15456 * Math.log10(h)) - 450;
            } else {
                bfp = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(h)) - 450;
            }
            showResult('bodyFat-results', `<h4>Estimated Body Fat: ${bfp.toFixed(1)}%</h4>`);
        };
        
        window.calculateIdealWeight = () => {
            const h = parseFloat(document.getElementById('iw-height').value), gender = document.getElementById('iw-gender').value;
            if (!h) return;
            const heightInInches = h / 2.54;
            let idealKg = 0;
            if (gender === 'male') {
                idealKg = 50 + 2.3 * (heightInInches - 60);
            } else {
                idealKg = 45.5 + 2.3 * (heightInInches - 60);
            }
            showResult('idealWeight-results', `<h4>Estimated Ideal Weight: ${idealKg.toFixed(1)} kg</h4>`);
        };
        
        window.calculateLBM = () => {
            const w = parseFloat(document.getElementById('lbm-weight').value), h = parseFloat(document.getElementById('lbm-height').value), gender = document.getElementById('lbm-gender').value;
            if (!w || !h) return;
            let lbm = 0;
            if (gender === 'male') {
                lbm = (0.407 * w) + (0.267 * h) - 19.2;
            } else {
                lbm = (0.252 * w) + (0.473 * h) - 48.3;
            }
            showResult('lbm-results', `<h4>Estimated Lean Body Mass: ${lbm.toFixed(1)} kg</h4>`);
        };

        window.calculateOvulation = () => {
            const lastPeriodDate = new Date(document.getElementById('ov-last-period').value);
            const cycleLength = parseInt(document.getElementById('ov-cycle-length').value);
            if (isNaN(lastPeriodDate.getTime()) || !cycleLength) return;
            
            const ovulationDate = new Date(lastPeriodDate);
            ovulationDate.setDate(lastPeriodDate.getDate() + cycleLength - 14);

            const fertileStart = new Date(ovulationDate);
            fertileStart.setDate(ovulationDate.getDate() - 5);
            
            const fertileEnd = new Date(ovulationDate);
            fertileEnd.setDate(ovulationDate.getDate() + 1);

            const options = { month: 'long', day: 'numeric' };
            showResult('ovulation-results', `<h4>Estimated Fertile Window:</h4><p>${fertileStart.toLocaleDateString(undefined, options)} - ${fertileEnd.toLocaleDateString(undefined, options)}</p>`);
        };
    });
    </script>
</body>
</html>
