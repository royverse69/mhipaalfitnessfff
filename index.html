<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calverse - AI Nutrition & Health</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide-icons@0.292.0/dist/lucide.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Your Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase project configuration.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose Firebase modules to the global window object for access in other scripts
        window.firebase = {
            app,
            auth,
            db,
            GoogleAuthProvider,
            signInWithPopup,
            onAuthStateChanged,
            signOut,
            setPersistence,
            browserLocalPersistence,
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            query,
            onSnapshot,
            orderBy,
            limit
        };

        // Initialize the app after the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.initializeApp();
        });
    </script>

    <style>
        /* Custom Styles */
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: 'Inter', sans-serif;
        }
        .accent-yellow { color: #FFD700; }
        .bg-accent-yellow { background-color: #FFD700; }
        .border-accent-yellow { border-color: #FFD700; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f1f1f; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FFD700; }

        /* Nutrition Label Styling */
        .nutrition-label {
            border: 2px solid #fff;
            padding: 0.5rem;
            max-width: 400px;
            margin: 1rem auto;
            font-family: 'Helvetica', 'Arial', sans-serif;
            background: #1a1a1a;
        }
        .nutrition-label h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0;
            letter-spacing: -2px;
        }
        .nutrition-label .line { height: 10px; background: #fff; }
        .nutrition-label .line.thick { height: 15px; }
        .nutrition-label .item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px solid #444;
        }
        .nutrition-label .item.indent { margin-left: 20px; }
        .nutrition-label .item span:first-child { font-weight: bold; }
        .nutrition-label .dv { text-align: right; font-weight: bold; }
        .nutrition-label .footer {
            font-size: 0.75rem;
            text-align: center;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 2px solid #fff;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32" style="border-top-color: #FFD700;"></div>
    </div>

    <!-- Main Content -->
    <div id="app-container" class="hidden w-full h-full flex">
        <!-- Sidebar Navigation -->
        <aside class="w-20 lg:w-64 bg-black/50 p-2 lg:p-4 flex flex-col justify-between transition-all duration-300">
            <div>
                <div class="flex items-center justify-center lg:justify-start mb-10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flame-kindling"><path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Z"/><path d="M12 2a2 2 0 0 0-2 2c0 1.1.9 2 2 2s2-.9 2-2a2 2 0 0 0-2-2Z"/><path d="M12 6h.01"/><path d="m15.6 9.4-.8.8"/><path d="M20 12h-1"/><path d="m15.6 14.6.8.8"/><path d="M12 18h.01"/><path d="M8.4 14.6-.8.8"/><path d="M4 12H3"/><path d="m8.4 9.4-.8.8"/></svg>
                    <span class="hidden lg:inline text-2xl font-bold ml-2">Calverse</span>
                </div>
                <nav id="main-nav" class="space-y-2">
                    <a href="#home" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-800 transition-colors duration-200 active">
                        <i data-lucide="home" class="w-6 h-6"></i>
                        <span class="hidden lg:inline ml-4 font-semibold">Home</span>
                    </a>
                    <a href="#nutrition" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-800 transition-colors duration-200">
                        <i data-lucide="utensils-crossed" class="w-6 h-6"></i>
                        <span class="hidden lg:inline ml-4 font-semibold">Food</span>
                    </a>
                    <a href="#calculators" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-800 transition-colors duration-200">
                        <i data-lucide="calculator" class="w-6 h-6"></i>
                        <span class="hidden lg:inline ml-4 font-semibold">Calculators</span>
                    </a>
                </nav>
            </div>
            <div id="profile-nav-item">
                <a href="#profile" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-800 transition-colors duration-200">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                    <span class="hidden lg:inline ml-4 font-semibold">Profile & Settings</span>
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 bg-[#121212] overflow-y-auto p-4 md:p-8 relative">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <h1 id="page-title" class="text-3xl font-bold">Welcome</h1>
                <div class="relative">
                    <img id="user-avatar" src="https://placehold.co/40x40/121212/FFD700?text=U" class="w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-accent-yellow">
                    <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-20">
                        <a href="#profile" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Edit Profile</a>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Logout</a>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div id="page-content">
                <!-- All sections will be dynamically loaded here -->
            </div>
            
            <!-- Floating Action Button for Profile Page -->
            <button id="fab" class="hidden fixed bottom-8 right-8 bg-accent-yellow text-black p-4 rounded-full shadow-lg hover:bg-yellow-300 transition-transform transform hover:scale-110">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button>
            
            <!-- Footer for Profile Page -->
            <footer id="page-footer" class="hidden text-center text-gray-500 py-4 mt-8">
                Made with <span class="text-red-500">&hearts;</span> by Ashutosh Roy
            </footer>
        </main>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="w-full h-full flex items-center justify-center">
        <div class="text-center p-8 bg-gray-900 rounded-xl shadow-2xl">
            <div class="flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flame-kindling"><path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Z"/><path d="M12 2a2 2 0 0 0-2 2c0 1.1.9 2 2 2s2-.9 2-2a2 2 0 0 0-2-2Z"/><path d="M12 6h.01"/><path d="m15.6 9.4-.8.8"/><path d="M20 12h-1"/><path d="m15.6 14.6.8.8"/><path d="M12 18h.01"/><path d="M8.4 14.6-.8.8"/><path d="M4 12H3"/><path d="m8.4 9.4-.8.8"/></svg>
                <h1 class="text-4xl font-bold ml-3">Calverse</h1>
            </div>
            <p class="text-gray-400 mb-8">Your AI-powered nutrition companion.</p>
            <button id="login-btn" class="flex items-center justify-center w-full bg-white text-black font-semibold py-3 px-6 rounded-lg hover:bg-gray-200 transition-colors duration-300">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#34A853" d="m43.611 20.083-7.637 6.021C37.631 24.643 38 23.352 38 22c0-1.925-.539-3.725-1.455-5.286l7.49-6.095C43.862 13.318 44 16.63 44 20c0 .333 0 .667-.01.999z"/><path fill="#FBBC05" d="M6.306 14.845c-2.16 3.9-2.16 8.41 0 12.31L.649 32.81C-2.215 26.736-2.215 19.264.649 13.189l5.657 1.656z"/><path fill="#EA4335" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-4.938C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Section Templates -->
    <template id="home-template">
        <div class="text-center">
            <h2 class="text-4xl font-extrabold mb-4">Welcome to <span class="accent-yellow">Calverse</span></h2>
            <p class="text-lg text-gray-400 max-w-2xl mx-auto">Your journey to smarter, healthier eating starts here. Use the navigation on the left to look up food nutrition, analyze your meals, or use our health calculators.</p>
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 hover:border-accent-yellow transition-all">
                    <i data-lucide="utensils-crossed" class="w-12 h-12 accent-yellow mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">Nutrition Lookup</h3>
                    <p class="text-gray-400">Instantly get detailed FDA-style nutrition facts for any food item.</p>
                </div>
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 hover:border-accent-yellow transition-all">
                    <i data-lucide="blender" class="w-12 h-12 accent-yellow mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">Meal Analysis</h3>
                    <p class="text-gray-400">Combine ingredients to see the full nutritional profile of your meal.</p>
                </div>
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 hover:border-accent-yellow transition-all">
                    <i data-lucide="calculator" class="w-12 h-12 accent-yellow mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">Health Calculators</h3>
                    <p class="text-gray-400">Calculate your BMI, BMR, daily calorie needs, and more.</p>
                </div>
            </div>
        </div>
    </template>

    <template id="nutrition-template">
        <!-- Nutrition Lookup -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-4">Nutrition Lookup</h2>
            <div class="flex flex-col sm:flex-row gap-2">
                <input id="nutrition-input" type="text" placeholder="e.g., 1 large apple or 100g chicken breast" class="flex-grow bg-gray-800 border border-gray-700 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-accent-yellow">
                <button id="nutrition-search-btn" class="bg-accent-yellow text-black font-bold p-3 rounded-lg flex items-center justify-center">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mt-4 flex gap-2 overflow-x-auto pb-2">
                <button class="food-chip">Oats</button>
                <button class="food-chip">Chicken Breast</button>
                <button class="food-chip">Banana</button>
                <button class="food-chip">Egg</button>
                <button class="food-chip">Broccoli</button>
                <button class="food-chip">Salmon</button>
            </div>
            <div id="nutrition-result" class="mt-6"></div>
        </div>

        <!-- Know Your Meal -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-4">Know Your Meal</h2>
            <div id="meal-ingredients" class="space-y-2">
                <div class="flex gap-2">
                    <input type="text" placeholder="Ingredient (e.g., 100g rice)" class="meal-ingredient-input flex-grow bg-gray-800 border border-gray-700 rounded-lg p-3">
                </div>
            </div>
            <button id="add-ingredient-btn" class="mt-2 text-sm accent-yellow hover:underline">+ Add Ingredient</button>
            <div class="mt-4">
                <input id="meal-link-input" type="text" placeholder="Or paste a recipe link (e.g., from YouTube)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3">
            </div>
            <button id="analyze-meal-btn" class="mt-4 w-full bg-accent-yellow text-black font-bold p-3 rounded-lg">Analyze Nutrition</button>
            <div id="meal-analysis-result" class="mt-6"></div>
        </div>

        <!-- Recipe Suggestion -->
        <div>
            <h2 class="text-2xl font-bold mb-4">Smart Recipe Builder</h2>
            <textarea id="recipe-ingredients-input" placeholder="List ingredients you have, separated by commas... (e.g., chicken, tomatoes, onion, garlic)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 h-24"></textarea>
            <button id="suggest-recipe-btn" class="mt-4 w-full bg-accent-yellow text-black font-bold p-3 rounded-lg">Suggest Recipes</button>
            <div id="recipe-suggestion-result" class="mt-6"></div>
        </div>
        
        <!-- Craving Fix -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold mb-4">Craving Something?</h2>
            <input id="craving-input" type="text" placeholder="e.g., chocolate cake, potato chips" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3">
            <button id="fix-craving-btn" class="mt-4 w-full bg-accent-yellow text-black font-bold p-3 rounded-lg">Find a Healthy Alternative</button>
            <div id="craving-fix-result" class="mt-6"></div>
        </div>
    </template>
    
    <template id="calculators-template">
        <div class="space-y-4" id="calculator-accordion">
            <!-- Calculators will be inserted here by JS -->
        </div>
    </template>
    
    <template id="profile-template">
        <div class="max-w-2xl mx-auto">
            <div class="bg-gray-800/50 p-6 rounded-lg text-center border border-gray-700">
                <img id="profile-page-avatar" src="https://placehold.co/100x100/121212/FFD700?text=U" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-accent-yellow">
                <h2 id="profile-name" class="text-2xl font-bold">User Name</h2>
                <p id="profile-email" class="text-gray-400">user.email@example.com</p>
                <p class="text-sm text-gray-500 mt-1">User ID: <span id="profile-uid"></span></p>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
                <div id="recent-activity-list" class="space-y-3">
                    <!-- Activity items will be loaded here -->
                    <p class="text-gray-500">No recent activity.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- JS -->
    <script>
    // --- Main App Logic (IIFE) ---
    (function() {
        // --- State Management ---
        let currentUser = null;
        let currentUserId = null;

        // --- Gemini API Configuration ---
        const GEMINI_API_KEYS = [
            "AIzaSyCiPL-DcZN82CxH6OmYv9Ll4yM3WiVjxXY",
            "AIzaSyAvU63lMyAjbSJfcTBuBnkZQ0DPoBpm6Ho",
            "AIzaSyAIJZmqyztvwoThqI7iu2-xzQr71aJaKEU",
            "AIzaSyAmbO3Szmr9vAj24MkRkbMQeQi1j7_-m4Y"
        ];
        let currentApiKeyIndex = 0;

        // --- DOM Elements ---
        const dom = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loginScreen: document.getElementById('login-screen'),
            appContainer: document.getElementById('app-container'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userAvatar: document.getElementById('user-avatar'),
            userDropdown: document.getElementById('user-dropdown'),
            pageTitle: document.getElementById('page-title'),
            pageContent: document.getElementById('page-content'),
            mainNav: document.getElementById('main-nav'),
            fab: document.getElementById('fab'),
            pageFooter: document.getElementById('page-footer'),
        };

        // --- Utility Functions ---
        const utils = {
            showLoading: () => dom.loadingOverlay.classList.remove('hidden'),
            hideLoading: () => dom.loadingOverlay.classList.add('hidden'),
            generateUserId: (displayName) => {
                const prefix = displayName.substring(0, 3).toLowerCase();
                const randomPart = Math.random().toString(36).substring(2, 8);
                return `${prefix}${randomPart}`;
            },
            logActivity: async (action, details) => {
                if (!currentUserId) return;
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'users', currentUserId, 'activity'), {
                        action,
                        details,
                        timestamp: new Date()
                    });
                } catch (error) {
                    console.error("Error logging activity:", error);
                }
            }
        };

        // --- Gemini API Handler ---
        const gemini = {
            call: async (prompt) => {
                utils.showLoading();
                for (let i = 0; i < GEMINI_API_KEYS.length; i++) {
                    const apiKey = GEMINI_API_KEYS[currentApiKeyIndex];
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }

                        const data = await response.json();
                        utils.hideLoading();
                        if (data.candidates && data.candidates.length > 0) {
                            return data.candidates[0].content.parts[0].text;
                        } else {
                           throw new Error("No content in Gemini response");
                        }
                    } catch (error) {
                        console.error(`Error with API key index ${currentApiKeyIndex}:`, error);
                        currentApiKeyIndex = (currentApiKeyIndex + 1) % GEMINI_API_KEYS.length;
                        if (i === GEMINI_API_KEYS.length - 1) {
                            utils.hideLoading();
                            alert("All API keys failed. Please check your connection or API key validity.");
                            return null;
                        }
                    }
                }
            }
        };

        // --- UI Rendering and Event Handling ---
        const ui = {
            renderPage: (hash) => {
                dom.pageContent.innerHTML = ''; // Clear previous content
                const route = hash.substring(1) || 'home';
                const template = document.getElementById(`${route}-template`);
                
                dom.fab.classList.add('hidden');
                dom.pageFooter.classList.add('hidden');

                if (template) {
                    const content = template.content.cloneNode(true);
                    dom.pageContent.appendChild(content);
                    dom.pageTitle.textContent = route.charAt(0).toUpperCase() + route.slice(1);
                    ui.setActiveNav(route);
                    ui.bindEventListenersForPage(route);
                } else {
                    // Fallback to home if route not found
                    dom.pageContent.appendChild(document.getElementById('home-template').content.cloneNode(true));
                    dom.pageTitle.textContent = 'Home';
                    ui.setActiveNav('home');
                }
                lucide.createIcons();
            },
            setActiveNav: (route) => {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('bg-accent-yellow', 'text-black');
                    if (item.getAttribute('href') === `#${route}`) {
                        item.classList.add('bg-accent-yellow', 'text-black');
                    }
                });
            },
            bindEventListenersForPage: (route) => {
                switch(route) {
                    case 'nutrition':
                        ui.bindNutritionEvents();
                        break;
                    case 'calculators':
                        ui.bindCalculatorEvents();
                        break;
                    case 'profile':
                        ui.bindProfileEvents();
                        break;
                }
            },
            bindNutritionEvents: () => {
                document.getElementById('nutrition-search-btn').onclick = handlers.handleNutritionSearch;
                document.querySelectorAll('.food-chip').forEach(chip => {
                    chip.onclick = () => {
                        document.getElementById('nutrition-input').value = chip.textContent;
                        handlers.handleNutritionSearch();
                    };
                });
                document.getElementById('add-ingredient-btn').onclick = handlers.handleAddIngredient;
                document.getElementById('analyze-meal-btn').onclick = handlers.handleMealAnalysis;
                document.getElementById('suggest-recipe-btn').onclick = handlers.handleRecipeSuggestion;
                document.getElementById('fix-craving-btn').onclick = handlers.handleCravingFix;
            },
            bindCalculatorEvents: () => {
                const calculators = [
                    { id: 'bmi', title: 'BMI Calculator', inputs: ['Height (cm)', 'Weight (kg)'], formula: (i) => (i[1] / ((i[0]/100)**2)).toFixed(2) },
                    { id: 'bmr', title: 'BMR Calculator', inputs: ['Age', 'Weight (kg)', 'Height (cm)'], gender: true, formula: (i, g) => (g === 'male' ? (88.362 + (13.397 * i[1]) + (4.799 * i[2]) - (5.677 * i[0])) : (447.593 + (9.247 * i[1]) + (3.098 * i[2]) - (4.330 * i[0]))).toFixed(0) },
                    // Add more calculators here
                ];
                const accordionContainer = document.getElementById('calculator-accordion');
                accordionContainer.innerHTML = calculators.map(calc => `
                    <div class="calculator-card bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                        <button class="w-full text-left p-4 flex justify-between items-center" data-calculator-id="${calc.id}">
                            <h3 class="text-lg font-bold">${calc.title}</h3>
                            <i data-lucide="chevron-down" class="transition-transform"></i>
                        </button>
                        <div class="calculator-content hidden p-4 border-t border-gray-700">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${calc.inputs.map(label => `<input type="number" placeholder="${label}" class="bg-gray-700 p-2 rounded">`).join('')}
                                ${calc.gender ? `<select class="bg-gray-700 p-2 rounded"><option value="male">Male</option><option value="female">Female</option></select>` : ''}
                            </div>
                            <button class="calc-btn mt-4 bg-accent-yellow text-black font-bold p-2 rounded w-full">Calculate</button>
                            <div class="calc-result mt-4 text-center font-bold text-2xl"></div>
                        </div>
                    </div>
                `).join('');
                
                document.querySelectorAll('.calculator-card button[data-calculator-id]').forEach(button => {
                    button.onclick = (e) => {
                        const content = button.nextElementSibling;
                        const icon = button.querySelector('i');
                        const isOpen = !content.classList.contains('hidden');

                        // Close all others
                        document.querySelectorAll('.calculator-content').forEach(c => c.classList.add('hidden'));
                        document.querySelectorAll('.calculator-card button i').forEach(i => i.classList.remove('rotate-180'));

                        if (!isOpen) {
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                        }
                    };
                });

                document.querySelectorAll('.calc-btn').forEach(btn => {
                    btn.onclick = () => {
                        const card = btn.closest('.calculator-card');
                        const id = card.querySelector('button[data-calculator-id]').dataset.calculatorId;
                        const calcDef = calculators.find(c => c.id === id);
                        const inputs = Array.from(card.querySelectorAll('input')).map(i => parseFloat(i.value));
                        const gender = card.querySelector('select')?.value;
                        
                        if (inputs.some(isNaN)) {
                            card.querySelector('.calc-result').textContent = 'Please fill all fields.';
                            return;
                        }
                        
                        const result = calcDef.formula(inputs, gender);
                        card.querySelector('.calc-result').innerHTML = `Result: <span class="accent-yellow">${result}</span>`;
                        utils.logActivity(`Calculated ${calcDef.title}`, { result });
                    };
                });
                lucide.createIcons();
            },
            bindProfileEvents: () => {
                dom.fab.classList.remove('hidden');
                dom.pageFooter.classList.remove('hidden');
                
                document.getElementById('profile-page-avatar').src = currentUser.photoURL;
                document.getElementById('profile-name').textContent = currentUser.displayName;
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-uid').textContent = currentUserId;

                // Fetch and display recent activity
                const activityList = document.getElementById('recent-activity-list');
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'users', currentUserId, 'activity'),
                    window.firebase.orderBy('timestamp', 'desc'),
                    window.firebase.limit(5)
                );

                window.firebase.onSnapshot(q, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        activityList.innerHTML = '<p class="text-gray-500">No recent activity.</p>';
                        return;
                    }
                    activityList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const activity = doc.data();
                        const date = activity.timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const activityItem = document.createElement('div');
                        activityItem.className = 'bg-gray-800 p-3 rounded-lg flex justify-between items-center';
                        activityItem.innerHTML = `
                            <span>${activity.action} - ${activity.details.query || activity.details.result || ''}</span>
                            <span class="text-sm text-gray-500">${date}</span>
                        `;
                        activityList.appendChild(activityItem);
                    });
                });
            },
            renderNutritionLabel: (data, containerId) => {
                const container = document.getElementById(containerId);
                // Basic parsing, assuming Gemini returns a clean JSON string
                try {
                    const nutrition = JSON.parse(data.replace(/```json|```/g, '').trim());
                    container.innerHTML = `
                        <div class="nutrition-label">
                            <h1>Nutrition Facts</h1>
                            <div class="line thick"></div>
                            <div class="item"><span>Serving Size</span> <span>${nutrition.serving_size || '100g'}</span></div>
                            <div class="line"></div>
                            <div class="item"><span>Calories</span> <span>${nutrition.calories || 'N/A'}</span></div>
                            <div class="line thick"></div>
                            <div class="item"><span></span> <span class="dv">% Daily Value*</span></div>
                            <div class="item"><span>Total Fat</span> <span>${nutrition.total_fat?.value || 'N/A'}</span> <span class="dv">${nutrition.total_fat?.dv || 'N/A'}</span></div>
                            <div class="item indent"><span>Saturated Fat</span> <span>${nutrition.saturated_fat?.value || 'N/A'}</span> <span class="dv">${nutrition.saturated_fat?.dv || 'N/A'}</span></div>
                            <div class="item indent"><span>Trans Fat</span> <span>${nutrition.trans_fat?.value || 'N/A'}</span></div>
                            <div class="item"><span>Cholesterol</span> <span>${nutrition.cholesterol?.value || 'N/A'}</span> <span class="dv">${nutrition.cholesterol?.dv || 'N/A'}</span></div>
                            <div class="item"><span>Sodium</span> <span>${nutrition.sodium?.value || 'N/A'}</span> <span class="dv">${nutrition.sodium?.dv || 'N/A'}</span></div>
                            <div class="item"><span>Total Carbohydrate</span> <span>${nutrition.total_carbohydrate?.value || 'N/A'}</span> <span class="dv">${nutrition.total_carbohydrate?.dv || 'N/A'}</span></div>
                            <div class="item indent"><span>Dietary Fiber</span> <span>${nutrition.dietary_fiber?.value || 'N/A'}</span> <span class="dv">${nutrition.dietary_fiber?.dv || 'N/A'}</span></div>
                            <div class="item indent"><span>Total Sugars</span> <span>${nutrition.total_sugars?.value || 'N/A'}</span></div>
                            <div class="item indent" style="margin-left: 40px;"><span>Includes Added Sugars</span> <span>${nutrition.added_sugars?.value || 'N/A'}</span> <span class="dv">${nutrition.added_sugars?.dv || 'N/A'}</span></div>
                            <div class="item"><span>Protein</span> <span>${nutrition.protein?.value || 'N/A'}</span></div>
                            <div class="line thick"></div>
                            <div class="footer">*The % Daily Value (DV) tells you how much a nutrient in a serving of food contributes to a daily diet. 2,000 calories a day is used for general nutrition advice.</div>
                        </div>
                    `;
                } catch (e) {
                    console.error("Failed to parse nutrition data:", e);
                    container.innerHTML = `<div class="bg-red-900 text-white p-4 rounded-lg">Error: Could not parse nutrition data from the AI. The response might be malformed. <br><pre class="mt-2 text-sm whitespace-pre-wrap">${data}</pre></div>`;
                }
            }
        };

        // --- Event Handlers ---
        const handlers = {
            handleLogin: async () => {
                utils.showLoading();
                const provider = new window.firebase.GoogleAuthProvider();
                try {
                    await window.firebase.setPersistence(window.firebase.auth, window.firebase.browserLocalPersistence);
                    const result = await window.firebase.signInWithPopup(window.firebase.auth, provider);
                    // This will trigger onAuthStateChanged, which handles the rest
                } catch (error) {
                    console.error("Login failed:", error);
                    alert("Google Sign-In failed. Please try again.");
                    utils.hideLoading();
                }
            },
            handleLogout: async () => {
                await window.firebase.signOut(window.firebase.auth);
                // onAuthStateChanged will handle UI changes
            },
            handleHashChange: () => {
                ui.renderPage(window.location.hash);
            },
            handleNutritionSearch: async () => {
                const query = document.getElementById('nutrition-input').value;
                if (!query) return;
                const prompt = `Provide detailed FDA-style nutrition facts for "${query}". Return the data as a single, minified JSON object. The JSON should have keys like "serving_size", "calories", "total_fat", "saturated_fat", "trans_fat", "cholesterol", "sodium", "total_carbohydrate", "dietary_fiber", "total_sugars", "added_sugars", and "protein". For nutrients with a Daily Value, make the value an object with "value" (e.g., "10g") and "dv" (e.g., "15%"). Example for total_fat: { "value": "8g", "dv": "10%" }.`;
                const result = await gemini.call(prompt);
                if (result) {
                    ui.renderNutritionLabel(result, 'nutrition-result');
                    utils.logActivity('Nutrition Lookup', { query });
                }
            },
            handleAddIngredient: () => {
                const container = document.getElementById('meal-ingredients');
                const newIngredient = document.createElement('div');
                newIngredient.className = 'flex gap-2';
                newIngredient.innerHTML = `
                    <input type="text" placeholder="Another ingredient" class="meal-ingredient-input flex-grow bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <button class="remove-ingredient-btn text-red-500 p-3"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                `;
                newIngredient.querySelector('.remove-ingredient-btn').onclick = () => newIngredient.remove();
                container.appendChild(newIngredient);
                lucide.createIcons();
            },
            handleMealAnalysis: async () => {
                const ingredients = Array.from(document.querySelectorAll('.meal-ingredient-input')).map(i => i.value).filter(Boolean);
                const link = document.getElementById('meal-link-input').value;
                if (ingredients.length === 0 && !link) return;

                const query = link ? `the recipe from this link: ${link}` : `a meal consisting of: ${ingredients.join(', ')}`;
                const prompt = `Analyze the nutrition for ${query}. First, provide the combined FDA-style nutrition facts as a single, minified JSON object, same format as before. Then, on a new line after the JSON, provide two personalized, actionable tips to improve the meal's health or taste, each tip starting with "TIP:".`;
                
                const result = await gemini.call(prompt);
                if (result) {
                    const resultContainer = document.getElementById('meal-analysis-result');
                    const parts = result.split('\n');
                    const jsonPart = parts.find(p => p.startsWith('{'));
                    const tips = parts.filter(p => p.startsWith('TIP:')).map(t => `<p class="mt-2 bg-green-900/50 p-3 rounded-lg">${t.replace('TIP: ', '')}</p>`).join('');

                    if (jsonPart) {
                        const nutritionContainer = document.createElement('div');
                        resultContainer.innerHTML = '';
                        resultContainer.appendChild(nutritionContainer);
                        ui.renderNutritionLabel(jsonPart, nutritionContainer.id = 'meal-nutrition-label');
                        
                        const tipsContainer = document.createElement('div');
                        tipsContainer.className = "mt-4";
                        tipsContainer.innerHTML = `<h3 class="font-bold text-lg">Suggestions</h3>${tips}`;
                        resultContainer.appendChild(tipsContainer);

                        utils.logActivity('Meal Analysis', { query: ingredients.join(', ') || link });
                    } else {
                        resultContainer.innerHTML = `<div class="bg-red-900 text-white p-4 rounded-lg">Could not extract nutrition data from the response.</div>`;
                    }
                }
            },
            handleRecipeSuggestion: async () => {
                const ingredients = document.getElementById('recipe-ingredients-input').value;
                if (!ingredients) return;
                const prompt = `I have these ingredients: ${ingredients}. Suggest 2-3 healthy and simple recipe ideas. For each recipe, provide a title, a short description, and a list of steps. Format the response clearly using Markdown.`;
                const result = await gemini.call(prompt);
                if (result) {
                    // This assumes a simple Markdown-like response that can be displayed directly.
                    // A more robust solution would parse the markdown.
                    document.getElementById('recipe-suggestion-result').innerHTML = `<div class="prose prose-invert bg-gray-800/50 p-4 rounded-lg">${result.replace(/\n/g, '<br>')}</div>`;
                    utils.logActivity('Recipe Suggestion', { query: ingredients });
                }
            },
            handleCravingFix: async () => {
                const craving = document.getElementById('craving-input').value;
                if (!craving) return;
                const prompt = `I'm craving ${craving}. Suggest a healthier, satisfying alternative. Provide its name, why it's a good alternative, and simple steps to prepare it. Format the response clearly using Markdown.`;
                const result = await gemini.call(prompt);
                if (result) {
                    document.getElementById('craving-fix-result').innerHTML = `<div class="prose prose-invert bg-gray-800/50 p-4 rounded-lg">${result.replace(/\n/g, '<br>')}</div>`;
                    utils.logActivity('Craving Fix', { query: craving });
                }
            }
        };

        // --- App Initialization ---
        window.initializeApp = () => {
            utils.showLoading();

            // Bind static event listeners
            dom.loginBtn.addEventListener('click', handlers.handleLogin);
            dom.logoutBtn.addEventListener('click', handlers.handleLogout);
            dom.userAvatar.addEventListener('click', () => dom.userDropdown.classList.toggle('hidden'));
            window.addEventListener('hashchange', handlers.handleHashChange);
            window.addEventListener('popstate', handlers.handleHashChange); // For browser back/forward

            // Close dropdown if clicked outside
            document.addEventListener('click', (event) => {
                if (!dom.userAvatar.contains(event.target) && !dom.userDropdown.contains(event.target)) {
                    dom.userDropdown.classList.add('hidden');
                }
            });

            // Auth state observer
            window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                if (user) {
                    currentUser = user;
                    // Check if user profile exists, if not, create it
                    const userRef = window.firebase.doc(window.firebase.db, 'users', user.uid);
                    const userSnap = await window.firebase.getDoc(userRef);

                    if (!userSnap.exists()) {
                        // First time login, create profile
                        const newUserId = utils.generateUserId(user.displayName);
                        currentUserId = newUserId;
                        await window.firebase.setDoc(userRef, {
                            uid: user.uid,
                            calverseId: newUserId,
                            displayName: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL,
                            createdAt: new Date()
                        });
                        await window.firebase.setDoc(window.firebase.doc(window.firebase.db, 'calverse_ids', newUserId), { uid: user.uid });
                    } else {
                        currentUserId = userSnap.data().calverseId;
                    }

                    // Update UI for logged-in state
                    dom.userAvatar.src = user.photoURL;
                    dom.loginScreen.classList.add('hidden');
                    dom.appContainer.classList.remove('hidden');
                    dom.appContainer.classList.add('flex');
                    
                    // Initial page load
                    handlers.handleHashChange();
                } else {
                    // User is signed out
                    currentUser = null;
                    currentUserId = null;
                    dom.loginScreen.classList.remove('hidden');
                    dom.appContainer.classList.add('hidden');
                    dom.appContainer.classList.remove('flex');
                }
                utils.hideLoading();
            });
        };
    })();
    </script>
</body>
</html>
